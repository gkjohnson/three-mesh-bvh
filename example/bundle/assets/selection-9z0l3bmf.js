import{J as K,n as re,V as D,Y as ue,t as fe,o as ie,C as he,W as pe,c as ye,D as we,A as me,P as ge,al as xe,G as Me,M as B,T as Pe,g as ve,aD as Se,f as Q,aE as be,s as Te,aF as Ce,aG as _,aH as $,ag as We,Q as Xe}from"./ExtendedTriangle-DttJMGjs.js";import{S as Ee}from"./stats.min-DbzWzcqd.js";import{g as Ye}from"./lil-gui.module.min-BH_YJbPT.js";import{O as De}from"./OrbitControls--aO4oMeG.js";import{I as U,N as Z,a as Ie,M as Re}from"./MeshBVH-DAC57waP.js";import{M as Ae}from"./MeshBVHHelper-DN_ezUtB.js";import"./_commonjsHelpers-CqkleIqs.js";class R{constructor(){this.dragging=!1}handlePointerDown(){this.dragging=!0}handlePointerUp(){this.dragging=!1}handlePointerMove(){}get points(){return[]}static normalizePoint(e,r){return[e/window.innerWidth*2-1,-(r/window.innerHeight*2-1)]}}const H=new K,F=new K,G=new K;class ae extends R{constructor(){super(),this.lassoPoints=[],this.prevX=-1/0,this.prevY=-1/0}handlePointerDown(e){super.handlePointerDown(),this.prevX=e.clientX,this.prevY=e.clientY,this.lassoPoints=[]}handlePointerMove(e){const r=e.clientX,o=e.clientY,[a,s]=R.normalizePoint(r,o);if(Math.abs(r-this.prevX)>=3||Math.abs(o-this.prevY)>=3){const n=(this.lassoPoints.length/3-1)*3;let c=!1;return this.lassoPoints.length>3&&(H.set(this.lassoPoints[n-3],this.lassoPoints[n-3+1]),F.set(this.lassoPoints[n],this.lassoPoints[n+1]),F.sub(H).normalize(),H.set(this.lassoPoints[n],this.lassoPoints[n+1]),G.set(a,s),G.sub(H).normalize(),c=F.dot(G)>.99),c?(this.lassoPoints[n]=a,this.lassoPoints[n+1]=s):this.lassoPoints.push(a,s,0),this.prevX=r,this.prevY=o,{changed:!0}}return{changed:!1}}get points(){return this.lassoPoints}}class Be extends R{constructor(){super(),this.startX=0,this.startY=0,this.currentX=0,this.currentY=0}handlePointerDown(e){super.handlePointerDown(),this.prevX=e.clientX,this.prevY=e.clientY;const[r,o]=R.normalizePoint(e.clientX,e.clientY);this.startX=r,this.startY=o,this.lassoPoints=[]}handlePointerMove(e){const r=e.clientX,o=e.clientY,[a,s]=R.normalizePoint(e.clientX,e.clientY);return this.currentX=a,this.currentY=s,r===this.prevX&&o===this.prevY?{changed:!1}:(this.prevX=r,this.prevY=o,{changed:!0})}get points(){return[[this.startX,this.startY,0],[this.currentX,this.startY,0],[this.currentX,this.currentY,0],[this.startX,this.currentY,0]].flat()}}function He(t){function e(l,d,f){const g=(d.y-l.y)*(f.x-d.x)-(d.x-l.x)*(f.y-d.y);return g==0?0:g>0?1:2}function r(l,d){return(l.x-d.x)*(l.x-d.x)+(l.y-d.y)*(l.y-d.y)}function o(l,d){const f=e(i,l,d);return f==0?r(i,d)>=r(i,l)?-1:1:f==2?-1:1}let a=1/0,s=-1;for(let l=0,d=t.length;l<d;l++){const f=t[l];f.y<a&&(s=l,a=f.y)}const i=t[s];t[s]=t[0],t[0]=i,t=t.sort(o);let n=1;const c=t.length;for(let l=1;l<c;l++){for(;l<c-1&&e(i,t[l],t[l+1])==0;)l++;t[n]=t[l],n++}if(n<3)return null;const u=[t[0],t[1],t[2]];for(let l=3;l<n;l++){for(;e(u[u.length-2],u[u.length-1],t[l])!==2;)u.pop();u.push(t[l])}return u}function q(t,e){function r(n,c,u){return(u.y-n.y)*(c.x-n.x)>(c.y-n.y)*(u.x-n.x)}const o=t.start,a=t.end,s=e.start,i=e.end;return r(o,s,i)!==r(a,s,i)&&r(o,a,s)!==r(o,a,i)}function L(t,e){return Le(t,e)%2===1}function Le(t,e){let r=0;const o=e[e.length-1];let a=o.start.y>o.end.y;for(let s=0,i=e.length;s<i;s++){const n=e[s],c=n.start.y>n.end.y;ze(t,n,a,c)&&r++,a=c}return r}function ze(t,e,r,o){const{start:a,end:s}=e,i=t.x,n=t.y,c=a.y,u=s.y;if(c===u||n>c&&n>u||n<c&&n<u)return!1;const l=a.x,d=s.x;if(i>l&&i>d)return!1;if(i<l&&i<d)return!(n===c&&r!==o);const f=d-l,P=u-c,X=-f,v=i-l,E=n-c,S=P*v+X*E;return Math.sign(S)!==Math.sign(P)}function Oe(t,e,r,o){O.copy(t.matrixWorld).premultiply(e.matrixWorldInverse).premultiply(e.projectionMatrix),ee.copy(t.matrixWorld).invert(),te.set(0,0,0).applyMatrix4(e.matrixWorld).applyMatrix4(ee);const a=j(Ge(r.points)),s=[],i=[];return t.geometry.boundsTree.shapecast({intersectsBounds:(n,c,u,l)=>{if(!o.useBoundsTree)return U;const d=Ue(n,Ne).map(p=>p.applyMatrix4(O));let f=1/0,g=-1/0,P=1/0;for(const p of d)p.y<f&&(f=p.y),p.y>g&&(g=p.y),p.x<P&&(P=p.x);const v=(s[l-1]||a).filter(p=>Fe(p,P,f,g));if(s[l]=v,v.length===0)return Z;const E=He(d),S=j(E,se);if(L(v[0].start,S))return U;for(const p of S)for(const de of v)if(q(p,de))return U;return L(E[0],v)?Ie:Z},intersectsTriangle:(n,c,u,l)=>{const d=c*3,f=d+0,g=d+1,P=d+2,X=o.useBoundsTree?s[l]:a;if(o.selectionMode==="centroid"||o.selectionMode==="centroid-visible"){if(z.copy(n.a).add(n.b).add(n.c).multiplyScalar(1/3),ne.copy(z).applyMatrix4(O),u||L(ne,X))return o.selectionMode==="centroid-visible"&&(n.getNormal(oe),V.origin.copy(z).addScaledVector(oe,1e-6),V.direction.subVectors(te,z),t.geometry.boundsTree.raycastFirst(V,fe))?!1:(i.push(f,g,P),o.selectWholeModel)}else if(o.selectionMode==="intersection"){if(u)return i.push(f,g,P),o.selectWholeModel;const v=[n.a,n.b,n.c].map(S=>S.applyMatrix4(O));for(const S of v)if(L(S,X))return i.push(f,g,P),o.selectWholeModel;const E=j(v,se);for(const S of E)for(const p of X)if(q(S,p))return i.push(f,g,P),o.selectWholeModel}return!1}}),i}const ee=new re,te=new D,V=new ue,z=new D,ne=new D,oe=new D,O=new re,Ne=new Array(8).fill().map(()=>new D),se=new Array(12).fill().map(()=>new ie);function Ue(t,e){const{min:r,max:o}=t;let a=0;for(let s=0;s<=1;s++)for(let i=0;i<=1;i++)for(let n=0;n<=1;n++){const c=e[a];c.x=s===0?r.x:o.x,c.y=i===0?r.y:o.y,c.z=n===0?r.z:o.z,a++}return e}function Fe(t,e,r,o){const a=t.start.x,s=t.start.y,i=t.end.x,n=t.end.y;return!(a<e&&i<e||s>o&&n>o||s<r&&n<r)}function j(t,e=null){return e===null&&(e=new Array(t.length).fill(null).map(()=>new ie)),t.map((r,o)=>{const a=t[(o+1)%t.length],s=e[o];return s.start.copy(r),s.end.copy(a),s})}function Ge(t){const e=[];for(let r=0;r<t.length;r+=3)e.push(new D(t[r],t[r+1],t[r+2]));return e}const h={toolMode:"lasso",selectionMode:"intersection",liveUpdate:!1,selectWholeModel:!1,wireframe:!1,useBoundsTree:!0,displayHelper:!1,helperDepth:10,rotate:!0};let x,w,T,N,k,C,m,y,I,M,Y,le,W,J=!1,A=!1,b=new ae;Ve();ce();function Ve(){le=document.getElementById("output");const t=new he(2503224);x=new pe({antialias:!0}),x.setPixelRatio(window.devicePixelRatio),x.setSize(window.innerWidth,window.innerHeight),x.setClearColor(t,1),x.shadowMap.enabled=!0,document.body.appendChild(x.domElement),T=new ye;const e=new we(16777215,3);e.castShadow=!0,e.shadow.mapSize.set(2048,2048),e.position.set(10,10,10),T.add(e),T.add(new me(11583173,2.5)),w=new ge(75,window.innerWidth/window.innerHeight,.1,50),w.position.set(2,4,6),w.far=100,w.updateProjectionMatrix(),T.add(w),m=new xe,m.material.color.set(16750592),m.renderOrder=1,m.position.z=-.2,m.depthTest=!1,m.scale.setScalar(1),w.add(m),W=new Me,T.add(W),y=new B(new Pe(1.5,.5,500,60).toNonIndexed(),new ve({polygonOffset:!0,polygonOffsetFactor:1})),y.geometry.boundsTree=new Re(y.geometry),y.geometry.setAttribute("color",new Se(new Array(y.geometry.index.count*3).fill(255),3,!0)),y.castShadow=!0,y.receiveShadow=!0,W.add(y),I=new Ae(y,10),W.add(I),M=new B,M.geometry=y.geometry.clone(),M.geometry.drawRange.count=0,M.material=new Q({opacity:.05,transparent:!0,depthWrite:!1}),M.material.color.set(16750592),M.renderOrder=1,W.add(M),Y=new B,Y.geometry=M.geometry,Y.material=new Q({opacity:.25,transparent:!0,wireframe:!0,depthWrite:!1}),Y.material.color.copy(M.material.color),Y.renderOrder=2,W.add(Y);const r=new be(10,10,16777215,16777215);r.material.opacity=.2,r.material.transparent=!0,r.position.y=-2.75,T.add(r);const o=new B(new Te,new Ce({color:0,opacity:.2,depthWrite:!1}));o.position.y=-2.74,o.rotation.x=-Math.PI/2,o.scale.setScalar(20),o.renderOrder=2,o.receiveShadow=!0,T.add(o),k=new Ee,document.body.appendChild(k.dom),C=new De(w,x.domElement),C.minDistance=3,C.touches.ONE=_.PAN,C.mouseButtons.LEFT=$.PAN,C.touches.TWO=_.ROTATE,C.mouseButtons.RIGHT=$.ROTATE,C.enablePan=!1,N=new Ye;const a=N.addFolder("selection");a.add(h,"toolMode",["lasso","box"]).onChange(i=>{i==="box"?b=new Be:b=new ae}),a.add(h,"selectionMode",["centroid","centroid-visible","intersection"]),a.add(h,"selectWholeModel"),a.add(h,"liveUpdate"),a.add(h,"useBoundsTree"),a.open();const s=N.addFolder("display");s.add(h,"wireframe"),s.add(h,"rotate"),s.add(h,"displayHelper"),s.add(h,"helperDepth",1,30,1).onChange(i=>{I.depth=i,I.update()}),s.open(),N.open(),x.domElement.addEventListener("pointerdown",i=>{b.handlePointerDown(i)}),x.domElement.addEventListener("pointerup",()=>{b.handlePointerUp(),m.visible=!1,b.points.length&&(A=!0)}),x.domElement.addEventListener("pointermove",i=>{if((1&i.buttons)===0)return;const{changed:n}=b.handlePointerMove(i);n&&(J=!0,m.visible=!0,h.liveUpdate&&(A=!0))}),window.addEventListener("resize",function(){w.aspect=window.innerWidth/window.innerHeight,w.updateProjectionMatrix(),x.setSize(window.innerWidth,window.innerHeight)},!1)}function ce(){k.update(),requestAnimationFrame(ce),y.material.wireframe=h.wireframe,I.visible=h.displayHelper;const t=b.points;J&&(m.geometry.setAttribute("position",new We(t.concat(t.slice(0,3)),3,!1)),m.frustumCulled=!1,J=!1),A&&(A=!1,t.length>0&&je());const e=Math.tan(Xe.DEG2RAD*w.fov/2)*m.position.z;m.scale.set(-e*w.aspect,-e,1),x.render(T,w),h.rotate&&(W.rotation.y+=.01,h.liveUpdate&&b.dragging&&(A=!0))}function je(){const t=window.performance.now(),e=Oe(y,w,b,h),r=window.performance.now()-t;le.innerText=`${r.toFixed(3)}ms`;const o=y.geometry.index,a=M.geometry.index;if(e.length&&h.selectWholeModel){for(let s=0,i=o.count;s<i;s++){const n=o.getX(s);a.setX(s,n)}M.geometry.drawRange.count=1/0,a.needsUpdate=!0}else{for(let s=0,i=e.length;s<i;s++){const n=o.getX(e[s]);a.setX(s,n)}M.geometry.drawRange.count=e.length,a.needsUpdate=!0}}
