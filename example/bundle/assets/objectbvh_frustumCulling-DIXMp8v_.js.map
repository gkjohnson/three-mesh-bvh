{"version":3,"file":"objectbvh_frustumCulling-DIXMp8v_.js","sources":["../../objectbvh_frustumCulling.js"],"sourcesContent":["import * as THREE from 'three';\nimport { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';\nimport { GUI } from 'three/examples/jsm/libs/lil-gui.module.min.js';\nimport Stats from 'stats.js';\nimport { BVHHelper, CONTAINED, INTERSECTED } from 'three-mesh-bvh';\nimport { RoundedBoxGeometry } from 'three/examples/jsm/geometries/RoundedBoxGeometry.js';\nimport { mergeVertices } from 'three/examples/jsm/utils/BufferGeometryUtils.js';\nimport { ObjectBVH } from './src/bvh/ObjectBVH.js';\n\nconst params = {\n\tanimate: true,\n\tthirdPerson: false,\n\tuseBVH: true,\n\tcheckBoundingSphere: false,\n\tshowHelper: false,\n\thelperDepth: 25,\n\thelperParents: false,\n};\n\nlet renderer, scene, camera, camera2, controls, stats;\nlet sceneBVH, bvhHelper, batchedMesh, cameraHelper;\nlet outputElement;\n\ninit();\ncreateObjects();\n\nfunction init() {\n\n\toutputElement = document.getElementById( 'output' );\n\n\t// Renderer\n\trenderer = new THREE.WebGLRenderer( { antialias: true } );\n\trenderer.setPixelRatio( window.devicePixelRatio );\n\trenderer.setSize( window.innerWidth, window.innerHeight );\n\trenderer.setClearColor( 0x131619, 1 );\n\trenderer.setAnimationLoop( render );\n\tdocument.body.appendChild( renderer.domElement );\n\n\t// Camera\n\tcamera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 100 );\n\tcamera.position.set( 18, 10, 0 );\n\n\tcamera2 = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 800 );\n\tcamera2.position.set( 0, 20, 400 );\n\tcamera2.lookAt( 0, 0, 0 );\n\n\tcameraHelper = new THREE.CameraHelper( camera );\n\n\t// Scene\n\tscene = new THREE.Scene();\n\tscene.fog = new THREE.Fog( 0x131619, 25, camera.far );\n\tscene.add( cameraHelper );\n\n\t// Lights\n\tconst light1 = new THREE.DirectionalLight( 0xffffff, 2.5 );\n\tlight1.position.set( 1, 2, 1 );\n\tconst light2 = new THREE.DirectionalLight( 0xffffff, 0.75 );\n\tlight2.position.set( - 1, - 2, - 1 );\n\tscene.add( light1, light2, new THREE.AmbientLight( 0xffffff, 0.75 ) );\n\n\t// Controls\n\tcontrols = new OrbitControls( camera, renderer.domElement );\n\tcontrols.enablePan = false;\n\tcontrols.enableDamping = true;\n\n\t// Stats\n\tstats = new Stats();\n\tdocument.body.appendChild( stats.dom );\n\n\t// GUI\n\tconst gui = new GUI();\n\tgui.add( params, 'animate' );\n\tgui.add( params, 'thirdPerson' );\n\tgui.add( params, 'useBVH' );\n\tgui.add( params, 'checkBoundingSphere' );\n\n\tconst helperFolder = gui.addFolder( 'Helper' );\n\thelperFolder.add( params, 'showHelper' );\n\thelperFolder.add( params, 'helperDepth', 1, 25, 1 ).onChange( v => {\n\n\t\tif ( bvhHelper ) {\n\n\t\t\tbvhHelper.depth = v;\n\t\t\tbvhHelper.update();\n\n\t\t}\n\n\t} );\n\thelperFolder.add( params, 'helperParents' ).onChange( v => {\n\n\t\tif ( bvhHelper ) {\n\n\t\t\tbvhHelper.displayParents = v;\n\t\t\tbvhHelper.update();\n\n\t\t}\n\n\t} );\n\n\t// Events\n\twindow.addEventListener( 'resize', () => {\n\n\t\tcamera.aspect = window.innerWidth / window.innerHeight;\n\t\tcamera.updateProjectionMatrix();\n\n\t\tcamera2.aspect = window.innerWidth / window.innerHeight;\n\t\tcamera2.updateProjectionMatrix();\n\n\t\tcameraHelper.update();\n\t\trenderer.setSize( window.innerWidth, window.innerHeight );\n\n\t} );\n\n}\n\nfunction createObjects() {\n\n\tconst COUNT = 500000;\n\tconst geometries = [\n\t\tnew THREE.TorusGeometry( 0.25, 0.1, 30, 30 ),\n\t\tnew THREE.SphereGeometry( 0.25, 30, 30 ),\n\t\tnew THREE.ConeGeometry( 0.25, 0.25 ),\n\t\tmergeVertices( new RoundedBoxGeometry( 0.25, 0.25, 0.5, 4, 1 ) ),\n\t];\n\tconst colors = [ 0xE91E63, 0x03A9F4, 0x4CAF50, 0xFFC107, 0x9C27B0 ].map( c => new THREE.Color( c ) );\n\n\t// Create BatchedMesh\n\tconst maxVerts = geometries.reduce( ( sum, g ) => sum + g.attributes.position.count, 0 );\n\tconst maxIndices = geometries.reduce( ( sum, g ) => sum + ( g.index?.count || 0 ), 0 );\n\tbatchedMesh = new THREE.BatchedMesh( COUNT, maxVerts, maxIndices, new THREE.MeshStandardMaterial( { roughness: 0.5 } ) );\n\tbatchedMesh.sortObjects = false;\n\n\tconst geoIds = geometries.map( g => batchedMesh.addGeometry( g ) );\n\tconst matrix = new THREE.Matrix4();\n\n\tfor ( let i = 0; i < COUNT; i ++ ) {\n\n\t\tconst id = batchedMesh.addInstance( geoIds[ i % geoIds.length ] );\n\t\tbatchedMesh.setMatrixAt( id, randomTransform( matrix ) );\n\t\tbatchedMesh.setColorAt( id, colors[ i % colors.length ] );\n\t\tbatchedMesh.setVisibleAt( id, false );\n\n\t}\n\n\tscene.add( batchedMesh );\n\tscene.updateMatrixWorld();\n\n\t// Create BVH\n\tsceneBVH = new ObjectBVH( batchedMesh );\n\tbvhHelper = new BVHHelper( batchedMesh, sceneBVH, params.helperDepth );\n\tbvhHelper.color.set( 0xffffff );\n\tbvhHelper.opacity = 0.1;\n\tbvhHelper.instanceId = - 1;\n\tscene.add( bvhHelper );\n\n}\n\nfunction updateVisibility() {\n\n\tconst { useBVH, checkBoundingSphere } = params;\n\n\t// Reset visibility\n\tbatchedMesh.perObjectFrustumCulled = ! useBVH;\n\tfor ( let i = 0; i < batchedMesh.instanceCount; i ++ ) {\n\n\t\tbatchedMesh.setVisibleAt( i, ! useBVH );\n\n\t}\n\n\tif ( ! useBVH ) {\n\n\t\treturn;\n\n\t}\n\n\t// Update camera\n\tcamera.updateMatrixWorld();\n\n\t// Setup frustum\n\tconst frustum = new THREE.Frustum();\n\tconst frustumMatrix = new THREE.Matrix4()\n\t\t.multiplyMatrices( camera.projectionMatrix, camera.matrixWorldInverse )\n\t\t.multiply( batchedMesh.matrixWorld );\n\tfrustum.setFromProjectionMatrix( frustumMatrix, camera.coordinateSystem, camera.reversedDepth );\n\n\t// BVH-accelerated frustum culling\n\tconst invMatrix = new THREE.Matrix4().copy( sceneBVH.matrixWorld ).invert();\n\tconst matrix = new THREE.Matrix4();\n\tconst sphere = new THREE.Sphere();\n\tconst point = new THREE.Vector3();\n\n\tsceneBVH.shapecast( {\n\t\tintersectsBounds: box => {\n\n\t\t\tif ( ! frustum.intersectsBox( box ) ) return;\n\n\t\t\t// Check if fully contained\n\t\t\tconst { min, max } = box;\n\t\t\tfor ( let x = - 1; x <= 1; x += 2 ) {\n\n\t\t\t\tfor ( let y = - 1; y <= 1; y += 2 ) {\n\n\t\t\t\t\tfor ( let z = - 1; z <= 1; z += 2 ) {\n\n\t\t\t\t\t\tpoint.set( x < 0 ? min.x : max.x, y < 0 ? min.y : max.y, z < 0 ? min.z : max.z );\n\t\t\t\t\t\tif ( ! frustum.containsPoint( point ) ) return INTERSECTED;\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\treturn CONTAINED;\n\n\t\t},\n\t\tintersectsObject: ( object, instanceId ) => {\n\n\t\t\tif ( checkBoundingSphere ) {\n\n\t\t\t\t// Optional sphere check for tighter culling\n\t\t\t\tconst geoId = object.getGeometryIdAt( instanceId );\n\t\t\t\tobject.getMatrixAt( instanceId, matrix );\n\t\t\t\tmatrix.premultiply( object.matrixWorld ).premultiply( invMatrix );\n\t\t\t\tobject.getBoundingSphereAt( geoId, sphere );\n\t\t\t\tsphere.applyMatrix4( matrix );\n\n\t\t\t\tif ( frustum.intersectsSphere( sphere ) ) {\n\n\t\t\t\t\tobject.setVisibleAt( instanceId, true );\n\n\t\t\t\t}\n\n\t\t\t} else {\n\n\t\t\t\tobject.setVisibleAt( instanceId, true );\n\n\t\t\t}\n\n\t\t},\n\t} );\n\n}\n\nfunction render() {\n\n\tstats.begin();\n\n\t// Update GUI settings\n\tif ( bvhHelper ) bvhHelper.visible = params.showHelper;\n\tif ( params.animate ) batchedMesh.rotation.y += 0.0005;\n\n\tcontrols.update();\n\n\tconst start = performance.now();\n\tupdateVisibility();\n\n\tif ( params.thirdPerson ) {\n\n\t\tbvhHelper.opacity = 0.05;\n\t\tcameraHelper.visible = true;\n\t\tscene.fog.far = 1e10;\n\t\trenderer.render( scene, camera2 );\n\n\t} else {\n\n\t\tbvhHelper.opacity = 0.5;\n\t\tcameraHelper.visible = false;\n\t\tscene.fog.far = camera.far;\n\t\trenderer.render( scene, camera );\n\n\t}\n\n\tconst delta = performance.now() - start;\n\n\toutputElement.innerText = `render: ${ delta.toFixed( 2 ) }ms\\nvisible: ${ batchedMesh._multiDrawCount }`;\n\n\tstats.end();\n\n}\n\nfunction randomTransform( matrix ) {\n\n\tconst d = Math.cbrt( Math.random() );\n\tconst pos = new THREE.Vector3().randomDirection().multiplyScalar( 300 * d );\n\tconst rot = new THREE.Quaternion().setFromEuler( new THREE.Euler(\n\t\tMath.random() * Math.PI * 2,\n\t\tMath.random() * Math.PI * 2,\n\t\tMath.random() * Math.PI * 2\n\t) );\n\tconst scale = new THREE.Vector3().setScalar( 1 + Math.random() * 3 );\n\treturn matrix.compose( pos, rot, scale );\n\n}\n"],"names":["params","renderer","scene","camera","camera2","controls","stats","sceneBVH","bvhHelper","batchedMesh","cameraHelper","outputElement","init","createObjects","THREE.WebGLRenderer","render","THREE.PerspectiveCamera","THREE.CameraHelper","THREE.Scene","THREE.Fog","light1","THREE.DirectionalLight","light2","THREE.AmbientLight","OrbitControls","Stats","gui","GUI","helperFolder","v","geometries","THREE.TorusGeometry","THREE.SphereGeometry","THREE.ConeGeometry","mergeVertices","RoundedBoxGeometry","colors","c","THREE.Color","maxVerts","sum","g","maxIndices","_a","THREE.BatchedMesh","THREE.MeshStandardMaterial","geoIds","matrix","THREE.Matrix4","i","id","randomTransform","ObjectBVH","BVHHelper","updateVisibility","useBVH","checkBoundingSphere","frustum","THREE.Frustum","frustumMatrix","invMatrix","sphere","THREE.Sphere","point","THREE.Vector3","box","min","max","x","y","z","INTERSECTED","CONTAINED","object","instanceId","geoId","start","delta","d","pos","rot","THREE.Quaternion","THREE.Euler","scale"],"mappings":"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"}