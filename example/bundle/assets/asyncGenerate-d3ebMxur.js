import{B as z,b as q,W as K,c as U,d as O,D as _,A as j,P as N,G as Y,M as G,e as J,f as Q,T as X,g as B,C as Z,h as ee}from"./ExtendedTriangle-hsPasuNU.js";/* empty css               */import{S as re}from"./stats.min-DbzWzcqd.js";import{g as ne}from"./lil-gui.module.min-BH_YJbPT.js";import{i as P,e as oe,M as v,c as H,C as V,S as te,A as ae}from"./MeshBVH-DQV6PBDm.js";import{G as ie,W as se}from"./GenerateMeshBVHWorker-vOgOjCfJ.js";import{B as T}from"./BVHHelper-DA_xcAFF.js";import"./_commonjsHelpers-CqkleIqs.js";const F=typeof navigator<"u"?navigator.hardwareConcurrency:4;class de extends se{constructor(){const a=new Worker(new URL(""+new URL("parallelMeshBVH.worker-BSqYw6h-.js",import.meta.url).href,import.meta.url),{type:"module"});if(super(a),this.name="ParallelMeshBVHWorker",this.maxWorkerCount=Math.max(F,4),!P())throw new Error("ParallelMeshBVHWorker: Shared Array Buffers are not supported.")}runTask(a,n,r={}){return new Promise((u,s)=>{if(r.indirect||oe(n,r),n.getAttribute("position").isInterleavedBufferAttribute||n.index&&n.index.isInterleavedBufferAttribute)throw new Error("ParallelMeshBVHWorker: InterleavedBufferAttribute are not supported for the geometry attributes.");a.onerror=d=>{s(new Error(`ParallelMeshBVHWorker: ${d.message}`))},a.onmessage=d=>{const{data:o}=d;if(o.error)s(new Error(o.error)),a.onmessage=null;else if(o.serialized){const{serialized:c,position:$}=o,M=v.deserialize(c,n,{setIndex:!1}),D={setBoundingBox:!0,...r};if(n.attributes.position.array=$,c.index)if(n.index)n.index.array=c.index;else{const L=new z(c.index,1,!1);n.setIndex(L)}D.setBoundingBox&&(n.boundingBox=M.getBoundingBox(new q)),r.onProgress&&r.onProgress(o.progress),u(M),a.onmessage=null}else r.onProgress&&r.onProgress(o.progress)};const f=n.index?n.index.array:null,h=n.attributes.position.array;a.postMessage({operation:"BUILD_BVH",maxWorkerCount:this.maxWorkerCount,index:H(f,SharedArrayBuffer),position:H(h,SharedArrayBuffer),options:{...r,onProgress:null,includedProgressCallback:!!r.onProgress,groups:[...n.groups]}})})}}class le{constructor(){if(P())return new de;{console.warn("ParallelMeshBVHWorker: SharedArrayBuffers not supported. Falling back to single-threaded GenerateMeshBVHWorker.");const a=new ie;return a.maxWorkerCount=F,a}}}const k=typeof SharedArrayBuffer<"u",e={useWebWorker:!0,maxWorkerCount:k?navigator.hardwareConcurrency:1,strategy:V,indirect:!1,useGroups:!1,radius:1,tube:.3,tubularSegments:500,radialSegments:500,p:3,q:5,displayBVH:!1,displayDepth:10};let m,w,g,i,E,x,t,l,S,W,C,R,I,y,b=!1;ue();function ue(){W=document.getElementById("output"),C=document.getElementById("loading-container"),R=document.querySelector("#loading-container .bar"),I=document.querySelector("#loading-container .text"),m=new K({antialias:!0}),m.setPixelRatio(window.devicePixelRatio),m.setSize(window.innerWidth,window.innerHeight),m.setClearColor(16763432,1),m.setAnimationLoop(ce),document.body.appendChild(m.domElement),g=new U,g.fog=new O(16763432,20,60);const a=new _(16777215,3);a.position.set(1,1,1),g.add(a),g.add(new j(11583173,2.5)),w=new N(75,window.innerWidth/window.innerHeight,.1,50),w.position.set(0,0,4),w.far=100,w.updateProjectionMatrix(),E=new ee,S=new re,document.body.appendChild(S.dom),l=new Y,g.add(l);for(let s=0;s<400;s++){const f=new G(new J(1,32,32),new Q);f.position.set(Math.random()-.5,Math.random()-.5,Math.random()-.5).multiplyScalar(70),f.scale.setScalar(Math.random()*.3+.1),l.add(f)}y=new le,window.WORKER=y,x=new ne;const n=x.addFolder("helper");n.add(e,"displayBVH").name("enabled").onChange(s=>{s&&t&&t.update()}),n.add(e,"displayDepth",1,50,1).onChange(s=>{t&&(t.depth=s,t.update())}),n.open();const r=x.addFolder("knot");r.add(e,"useGroups"),r.add(e,"radius",.5,2,.01),r.add(e,"tube",.2,1.2,.01),r.add(e,"tubularSegments",50,2e3,1),r.add(e,"radialSegments",5,2e3,1),r.add(e,"p",1,10,1),r.add(e,"q",1,10,1),r.open();const u=x.addFolder("bvh");u.add(e,"useWebWorker"),u.add(e,"indirect"),u.add(e,"maxWorkerCount",1,16,1).disable(!k),u.add(e,"strategy",{CENTER:V,AVERAGE:ae,SAH:te}),x.add({regenerateKnot:A},"regenerateKnot").name("regenerate"),A(),window.addEventListener("resize",function(){w.aspect=window.innerWidth/window.innerHeight,w.updateProjectionMatrix(),m.setSize(window.innerWidth,window.innerHeight)},!1)}function A(){if(b)return;b=!0,i&&(Array.isArray(i.material)?i.material.forEach(d=>d.dispose()):i.material.dispose(),i.geometry.dispose(),l.remove(i),l.remove(t));const p=window.performance.now(),a=window.performance.now();let n;const r=new X(e.radius,e.tube,e.tubularSegments,e.radialSegments,e.p,e.q);if(e.useGroups){r.clearGroups();const d=r.index.count/3,o=Math.floor(d/3);r.addGroup(0,o*3,0),r.addGroup(o*1*3,o*3,1),r.addGroup(o*2*3,o*3,2),n=[new B({color:5093036,roughness:.75}),new B({color:15753874,roughness:.75}),new B({color:6600182,roughness:.75})]}else n=new B({color:new Z(5093036),roughness:.75});i=new G(r,n);const u=window.performance.now()-a,s=window.performance.now(),f={strategy:e.strategy,indirect:e.indirect};let h;if(e.useWebWorker){const d=o=>{const c=(o*100).toFixed(0);C.style.visibility="visible",R.style.width=`${c}%`,I.innerText=`${c}%`};y.maxWorkerCount=e.maxWorkerCount,y.generate(i.geometry,{onProgress:d,...f}).then(o=>{C.style.visibility="hidden",i.geometry.boundsTree=o,l.add(i);const c=window.performance.now()-s;b=!1,t=new T(i,0),t.depth=e.displayDepth,e.displayBVH&&t.update(),l.add(t),W.textContent=`Geometry Generation Time  : ${u.toFixed(3)}ms
BVH Generation Time       : ${c.toFixed(3)}ms
Frame Stall Time          : ${h.toFixed(3)}
SharedArrayBuffer Support : ${k}`}),h=window.performance.now()-p}else{i.geometry.boundsTree=new v(i.geometry,f),h=window.performance.now()-p,l.add(i);const d=window.performance.now()-s;b=!1,t=new T(i),t.depth=e.displayDepth,t.update(),l.add(t),W.textContent=`Geometry Generation Time  : ${u.toFixed(3)}ms
BVH Generation Time       : ${d.toFixed(3)}ms
Frame Stall Time          : ${h.toFixed(3)}`}}function ce(){S.update();let p=E.getDelta();l.rotation.x+=.4*p,l.rotation.y+=.6*p,t&&(t.visible=e.displayBVH),m.render(g,w)}
//# sourceMappingURL=asyncGenerate-d3ebMxur.js.map
