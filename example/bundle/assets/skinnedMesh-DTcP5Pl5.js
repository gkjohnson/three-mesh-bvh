import{V as E,ba as re,n as ae,Y as oe,x as se,y as ce,U as I,J as z,aB as Z,W as de,ae as le,c as pe,D as ue,A as fe,P as he,k as me,e as we,f as xe,M as Y,bb as be,aK as ye,b as ve,s as ge,b3 as Me,h as He}from"./ExtendedTriangle-hsPasuNU.js";import{G as Se}from"./GLTFLoader-Be-eETKy.js";import{S as Te}from"./stats.min-DbzWzcqd.js";import{g as Pe}from"./lil-gui.module.min-BH_YJbPT.js";import{O as Ee}from"./OrbitControls-DEZHvbFX.js";import{G as Ce,l as J,I as Be,N as Ie}from"./MeshBVH-DQV6PBDm.js";import{g as Fe}from"./Debug-DgSlAya1.js";import{B as Ve}from"./BVHHelper-DA_xcAFF.js";import"./BufferGeometryUtils-BuPYlHUL.js";import"./_commonjsHelpers-CqkleIqs.js";const X=new E,j=new E,q=new E,P=new oe,Q=new ae,R=new E,ke=["x","y","z"],Oe=Z.prototype.raycast,Re=function(d,e){this.boundsTree?this.boundsTree.raycastObject3D(this,d,e):Oe.call(this,d,e)};class Ae extends Ce{get primitiveStride(){return 3}constructor(e,n={}){if(!e.isMesh)throw new Error("SkinnedMeshBVH: First argument must be a Mesh.");super(e.geometry,{...n,[J]:!0}),this.mesh=e,n[J]||this.init(n)}writePrimitiveBounds(e,n,s){const{mesh:a,geometry:f}=this,r=this._indirectBuffer,o=f.index?f.index.array:null,t=(r?r[e]:e)*3;let h=t+0,i=t+1,p=t+2;o&&(h=o[h],i=o[i],p=o[p]),a.getVertexPosition(h,X),a.getVertexPosition(i,j),a.getVertexPosition(p,q);for(let c=0;c<3;c++){const w=ke[c],T=X[w],H=j[w],x=q[w];let b=T;H<b&&(b=H),x<b&&(b=x);let y=T;H>y&&(y=H),x>y&&(y=x),n[s+c]=b,n[s+c+3]=y}return n}shapecast(e){const n=new re;return super.shapecast({...e,intersectsPrimitive:e.intersectsTriangle,scratchPrimitive:n,iterate:Le})}raycastObject3D(e,n,s=[]){const{material:a}=e;if(a===void 0)return;const{matrixWorld:f}=e,{firstHitOnly:r}=n;Q.copy(f).invert(),P.copy(n.ray).applyMatrix4(Q);let o=null,l=1/0;return this.shapecast({boundsTraverseOrder:t=>t.distanceToPoint(P.origin),intersectsBounds:t=>P.intersectsBox(t)?Be:Ie,intersectsTriangle:(t,h)=>{let i=null;if(a.side===se?i=P.intersectTriangle(t.a,t.b,t.c,!0,R):a.side===ce?i=P.intersectTriangle(t.c,t.b,t.a,!0,R):i=P.intersectTriangle(t.a,t.b,t.c,!1,R),!i)return;i=i.clone().applyMatrix4(f);const p=n.ray.origin.distanceTo(i);if(p>=n.near&&p<=n.far){if(r&&p>=l)return;const{geometry:c}=this,{index:w}=c,H=this.resolvePrimitiveIndex(h)*3;let x=H+0,b=H+1,y=H+2;w&&(x=w.array[x],b=w.array[b],y=w.array[y]);const B=new E;I.getBarycoord(R,t.a,t.b,t.c,B);const S={distance:p,point:i.clone(),object:e,barycoord:B,uv:null,uv1:null,normal:null,face:{a:x,b,c:y,normal:I.getNormal(t.a,t.b,t.c,new E),materialIndex:0},faceIndex:x},U=c.attributes.uv,$=c.attributes.uv1,K=c.attributes.normal;U&&(S.uv=I.getInterpolatedAttribute(U,x,b,y,B,new z)),$&&(S.uv1=I.getInterpolatedAttribute($,x,b,y,B,new z)),K&&(S.normal=I.getInterpolatedAttribute(K,x,b,y,B,new E),S.normal.dot(P.direction)>0&&S.normal.multiplyScalar(-1)),l=S.distance,o=S,r||s.push(S)}}}),r&&o&&s.push(o),s}}function Le(d,e,n,s,a,f,r){const{mesh:o,geometry:l}=n,t=l.index?l.index.array:null;for(let h=d,i=e+d;h<i;h++){const p=n.resolvePrimitiveIndex(h);let c=3*p+0,w=3*p+1,T=3*p+2;if(t&&(c=t[c],w=t[w],T=t[T]),o.getVertexPosition(c,r.a),o.getVertexPosition(w,r.b),o.getVertexPosition(T,r.c),r.needsUpdate=!0,s(r,h,a,f))return!0}return!1}const u={skeletonHelper:!1,bvhHelper:!0,bvhHelperDepth:10,autoUpdate:!0,pause:!1,refit:()=>ne(),bvhRaycast:!0};let v,m,g,ee,F,N,O,V,D,k,M,A,te=0,_=[],W=[],G,L,C;De();function De(){O=document.getElementById("output"),v=new de({antialias:!0}),v.setPixelRatio(window.devicePixelRatio),v.setSize(window.innerWidth,window.innerHeight),v.setClearColor(1118481,1),v.setAnimationLoop(We),v.shadowMap.enabled=!0,v.shadowMap.type=le,document.body.appendChild(v.domElement),g=new pe;const e=new ue(16777215,3);e.position.set(5,5,2.5),e.shadow.mapSize.setScalar(1024),e.shadow.normalBias=.01,e.castShadow=!0;const n=e.shadow.camera;n.left=n.bottom=-7.5,n.right=n.top=7.5,n.updateProjectionMatrix(),g.add(e),g.add(new fe(11583173,2.4)),m=new he(75,window.innerWidth/window.innerHeight,.1,50),m.position.set(10,0,0),m.far=100,m.updateProjectionMatrix(),V=new Ee(m,v.domElement),ee=new He,N=new Te,document.body.appendChild(N.dom),G=new me,G.firstHitOnly=!0,L=new z;const s=new we(.05,32,32),a=new xe({color:16776960,opacity:.5,transparent:!0});C=new Y(s,a),C.visible=!1,g.add(C),new Se().load("https://raw.githubusercontent.com/gkjohnson/3d-demo-data/main/models/trex/scene.gltf",l=>{M=l.scene,M.traverse(i=>{if(i.isMesh){i.castShadow=!0,i.receiveShadow=!0,i.frustumCulled=!1;const p=new Ae(i),c=new Ve(i,p,u.bvhHelperDepth);c.update(),g.add(c),_.push(p),W.push(c),i.boundsTree=p}}),M.updateMatrixWorld(!0),g.add(M),A=new be(M),A.visible=!1,g.add(A);const t=l.animations;D=new ye(M),k=D.clipAction(t[0]),k.play(),k.paused=u.pause;const h=new ve;h.setFromObject(M),h.getCenter(V.target),V.target.z+=3,m.position.copy(V.target),m.position.x+=6.5,m.position.y+=2.5,m.position.z+=6.5,V.update(),te=ie(_)});const f=new Y(new ge,new Me({color:16777215,opacity:.025,transparent:!0}));f.rotation.x=-Math.PI/2,f.receiveShadow=!0,f.scale.setScalar(50),g.add(f),F=new Pe,F.add(u,"pause").onChange(l=>{k&&(k.paused=l)});const r=F.addFolder("helpers");r.add(u,"skeletonHelper"),r.add(u,"bvhHelper"),r.add(u,"bvhHelperDepth",1,20,1).onChange(l=>{W.forEach(t=>{t.depth=parseInt(l),t.update()})}),r.open();const o=F.addFolder("bvh");o.add(u,"bvhRaycast"),o.add(u,"autoUpdate"),o.add(u,"refit"),o.open(),F.open(),window.addEventListener("resize",function(){m.aspect=window.innerWidth/window.innerHeight,m.updateProjectionMatrix(),v.setSize(window.innerWidth,window.innerHeight)},!1),window.addEventListener("pointermove",function(l){L.x=l.clientX/window.innerWidth*2-1,L.y=-(l.clientY/window.innerHeight)*2+1},!1)}function ne(){let d;const e=performance.now();_.forEach(a=>{a.refit()}),d=performance.now()-e,W.forEach(a=>{a.update()});const s=ie(_)/te-1;O.innerHTML=`refit time: ${d.toFixed(2)} ms
bvh degradation: ${(100*s).toFixed(2)}%`}function ie(d){let e=0;return d.forEach(n=>{const s=Fe(n);for(const a in s)e+=s[a].surfaceAreaScore}),e}function _e(){if(!M)return;G.setFromCamera(L,m);const d=u.bvhRaycast?Re:Z.prototype.raycast;M.traverse(o=>{o.isSkinnedMesh&&(o.raycast=d)});const e=window.performance.now(),s=G.intersectObject(M,!0)[0];s?(C.position.copy(s.point),C.visible=!0):C.visible=!1;const a=window.performance.now()-e,r=O.innerHTML.split(`
`);r.length>1?O.innerHTML=r[0]+`
`+r[1]+`
raycast time: ${a.toFixed(2)} ms`:O.innerHTML=`raycast time: ${a.toFixed(2)} ms`}function We(){N.update();const d=Math.min(ee.getDelta(),30*.001);D&&(D.update(d),A.visible=u.skeletonHelper,W.forEach(e=>{e.visible=u.bvhHelper})),g.updateMatrixWorld(!0),u.autoUpdate&&!u.pause&&ne(),_e(),v.render(g,m)}
//# sourceMappingURL=skinnedMesh-DTcP5Pl5.js.map
