{"version":3,"file":"objectbvh_characterMovement-H6K52_Bw.js","sources":["../../objectbvh_characterMovement.js"],"sourcesContent":["import * as THREE from 'three';\nimport { RoundedBoxGeometry } from 'three/examples/jsm/geometries/RoundedBoxGeometry.js';\nimport { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';\nimport { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';\nimport Stats from 'stats.js';\nimport { GUI } from 'three/examples/jsm/libs/lil-gui.module.min.js';\nimport { MeshBVH, BVHHelper } from 'three-mesh-bvh';\nimport { ObjectBVH } from './src/bvh/ObjectBVH.js';\n\nconst params = {\n\tfirstPerson: false,\n\tdisplayBVH: false,\n\tvisualizeDepth: 10,\n\tgravity: - 80,\n\tplayerSpeed: 10,\n\tphysicsSteps: 5,\n\treset: () => reset(),\n};\n\nconst OFF_GROUND_TIME = 0.05;\nconst WALK_CYCLE_TIME = 2 * Math.PI;\n\n// Module-level reusable vectors/matrices for physics calculations\nconst _playerVelocity = new THREE.Vector3();\nconst _upVector = new THREE.Vector3( 0, 1, 0 );\nconst _tempVector = new THREE.Vector3();\nconst _tempVector2 = new THREE.Vector3();\nconst _sceneLocalBox = new THREE.Box3();\nconst _objectLocalBox = new THREE.Box3();\nconst _invMat = new THREE.Matrix4();\nconst _worldSegment = new THREE.Line3();\nconst _localSegment = new THREE.Line3();\nconst _sphere = new THREE.Sphere();\n\nlet renderer, camera, scene, clock, stats, controls;\nlet level, player, playerMesh, sceneBVH, sceneHelper;\nlet playerIsOnGround = false;\nlet offGroundTimer = OFF_GROUND_TIME;\nlet walkAnimation = 0;\n\nconst keys = { fwd: false, bkd: false, lft: false, rgt: false };\n\ninit();\nrenderer.setAnimationLoop( render );\n\nfunction init() {\n\n\tconst bgColor = 0x131619;\n\n\t// Renderer\n\trenderer = new THREE.WebGLRenderer( { antialias: true } );\n\trenderer.setPixelRatio( window.devicePixelRatio );\n\trenderer.setSize( window.innerWidth, window.innerHeight );\n\trenderer.setClearColor( bgColor, 1 );\n\trenderer.shadowMap.enabled = true;\n\trenderer.shadowMap.type = THREE.PCFShadowMap;\n\tdocument.body.appendChild( renderer.domElement );\n\n\t// Scene\n\tscene = new THREE.Scene();\n\n\t// Camera\n\tcamera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 200 );\n\tcamera.position.set( 15, 7.5, 15 );\n\n\t// Lights\n\tconst light = new THREE.DirectionalLight( 0xffffff, 3 );\n\tlight.position.set( 50, 75, 50 );\n\tlight.shadow.mapSize.setScalar( 2048 );\n\tlight.shadow.bias = - 1e-4;\n\tlight.shadow.normalBias = 0.05;\n\tlight.shadow.radius = 3;\n\tlight.castShadow = true;\n\n\tconst shadowCam = light.shadow.camera;\n\tshadowCam.left = shadowCam.bottom = - 30;\n\tshadowCam.top = 30;\n\tshadowCam.right = 45;\n\n\tscene.add( light, new THREE.HemisphereLight( 0xffffff, 0x223344, 0.4 ) );\n\n\t// Controls\n\tcontrols = new OrbitControls( camera, renderer.domElement );\n\tclock = new THREE.Clock();\n\n\t// Stats\n\tstats = new Stats();\n\tdocument.body.appendChild( stats.dom );\n\n\t// Load environment\n\tloadColliderEnvironment();\n\n\t// Create player\n\tplayer = new THREE.Group();\n\tplayer.rotation.y = Math.PI / 2;\n\tplayer.capsuleInfo = {\n\t\tradius: 0.75,\n\t\tsegment: new THREE.Line3( new THREE.Vector3( 0, 0.75, 0 ), new THREE.Vector3( 0, 1.0, 0 ) )\n\t};\n\n\t// Player mesh parts\n\tplayerMesh = new THREE.Group();\n\tplayer.add( playerMesh );\n\n\tconst material = new THREE.MeshStandardMaterial( { shadowSide: 2 } );\n\n\tconst body = new THREE.Mesh( new RoundedBoxGeometry( 1.0, 2.0, 1.0, 10, 0.5 ), material );\n\tbody.position.y = 0.75;\n\tbody.castShadow = body.receiveShadow = true;\n\n\tconst arms = new THREE.Mesh( new RoundedBoxGeometry( 0.5, 2.0, 0.5, 10, 0.5 ), material );\n\tarms.rotation.x = Math.PI / 2;\n\tarms.position.y = 1.25;\n\tarms.castShadow = arms.receiveShadow = true;\n\n\tconst head = new THREE.Mesh( new THREE.SphereGeometry( 0.5 ), material );\n\thead.position.y = 2;\n\thead.castShadow = head.receiveShadow = true;\n\n\tplayerMesh.add( body, arms, head );\n\tscene.add( player );\n\treset();\n\n\t// GUI\n\tconst gui = new GUI();\n\tgui.add( params, 'firstPerson' ).onChange( v => {\n\n\t\tif ( ! v ) {\n\n\t\t\tcamera.position\n\t\t\t\t.sub( controls.target )\n\t\t\t\t.normalize()\n\t\t\t\t.multiplyScalar( 10 )\n\t\t\t\t.add( controls.target );\n\n\t\t}\n\n\t} );\n\n\tconst visFolder = gui.addFolder( 'Visualization' );\n\tvisFolder.add( params, 'displayBVH' );\n\tvisFolder.add( params, 'visualizeDepth', 1, 20, 1 ).onChange( () => {\n\n\t\tsceneHelper.depth = params.visualizeDepth;\n\t\tsceneHelper.update();\n\n\t} );\n\n\tconst physicsFolder = gui.addFolder( 'Player' );\n\tphysicsFolder.add( params, 'physicsSteps', 0, 30, 1 );\n\tphysicsFolder.add( params, 'gravity', - 100, 100, 0.01 );\n\tphysicsFolder.add( params, 'playerSpeed', 1, 20 );\n\n\tgui.add( params, 'reset' );\n\n\t// Event listeners\n\twindow.addEventListener( 'resize', () => {\n\n\t\tcamera.aspect = window.innerWidth / window.innerHeight;\n\t\tcamera.updateProjectionMatrix();\n\t\trenderer.setSize( window.innerWidth, window.innerHeight );\n\n\t} );\n\n\twindow.addEventListener( 'keydown', e => {\n\n\t\tswitch ( e.code ) {\n\n\t\t\tcase 'KeyW': keys.fwd = true; break;\n\t\t\tcase 'KeyS': keys.bkd = true; break;\n\t\t\tcase 'KeyD': keys.rgt = true; break;\n\t\t\tcase 'KeyA': keys.lft = true; break;\n\t\t\tcase 'Space':\n\t\t\t\tif ( playerIsOnGround || offGroundTimer > 0 ) {\n\n\t\t\t\t\t_playerVelocity.y = 20.0;\n\t\t\t\t\tplayerIsOnGround = false;\n\t\t\t\t\toffGroundTimer = 0;\n\n\t\t\t\t}\n\n\t\t\t\tbreak;\n\n\t\t}\n\n\t} );\n\n\twindow.addEventListener( 'keyup', e => {\n\n\t\tswitch ( e.code ) {\n\n\t\t\tcase 'KeyW': keys.fwd = false; break;\n\t\t\tcase 'KeyS': keys.bkd = false; break;\n\t\t\tcase 'KeyD': keys.rgt = false; break;\n\t\t\tcase 'KeyA': keys.lft = false; break;\n\n\t\t}\n\n\t} );\n\n}\n\nfunction loadColliderEnvironment() {\n\n\tnew GLTFLoader().load( new URL( './models/grandmas_house_compressed.glb', import.meta.url ).toString(), res => {\n\n\t\tconst gltfScene = res.scene;\n\t\tgltfScene.scale.setScalar( 1.75 );\n\t\tgltfScene.updateMatrixWorld( true );\n\n\t\t// Setup materials and geometry\n\t\tconst toRemove = [];\n\t\tgltfScene.traverse( c => {\n\n\t\t\tif ( c.material?.isMeshPhysicalMaterial ) {\n\n\t\t\t\tc.material.transmission = 0;\n\n\t\t\t}\n\n\t\t\t// Remove cat/sheep models\n\t\t\tif ( /cat|sheep/.test( c.name ) ) {\n\n\t\t\t\tc.traverse( child => {\n\n\t\t\t\t\tif ( child.material ) {\n\n\t\t\t\t\t\tchild.material = child.material.clone();\n\t\t\t\t\t\tchild.material.color.set( 0xff0000 );\n\n\t\t\t\t\t}\n\n\t\t\t\t} );\n\t\t\t\ttoRemove.push( c );\n\t\t\t\treturn;\n\n\t\t\t}\n\n\t\t\tc.castShadow = c.receiveShadow = true;\n\t\t\tif ( c.isMesh && ! c.geometry.boundsTree ) {\n\n\t\t\t\tc.geometry.boundsTree = new MeshBVH( c.geometry );\n\n\t\t\t}\n\n\t\t} );\n\n\t\ttoRemove.forEach( c => c.removeFromParent() );\n\n\t\tlevel = gltfScene;\n\t\tscene.add( level );\n\n\t\tlevel.updateMatrixWorld( true );\n\t\tsceneBVH = new ObjectBVH( level, { maxLeafSize: 1 } );\n\n\t\tsceneHelper = new BVHHelper( level, sceneBVH );\n\t\tsceneHelper.opacity = 0.5;\n\t\tsceneHelper.color.set( 0xffffff );\n\t\tsceneHelper.update();\n\t\tscene.add( sceneHelper );\n\n\t} );\n\n}\n\nfunction reset() {\n\n\t_playerVelocity.set( 0, 0, 0 );\n\tplayer.position.set( 8, 10, 2.5 );\n\tcamera.position.sub( controls.target );\n\tcontrols.target.copy( player.position );\n\tcamera.position.add( player.position );\n\tcontrols.update();\n\n}\n\nfunction updatePlayer( delta ) {\n\n\tplayer.updateMatrixWorld();\n\t_invMat.copy( sceneBVH.matrixWorld ).invert();\n\n\t// Get capsule in world space\n\tconst capsuleInfo = player.capsuleInfo;\n\t_worldSegment\n\t\t.copy( capsuleInfo.segment )\n\t\t.applyMatrix4( player.matrixWorld );\n\n\t// Apply gravity\n\t_playerVelocity.y += delta * params.gravity;\n\t_worldSegment.start.addScaledVector( _playerVelocity, delta );\n\t_worldSegment.end.addScaledVector( _playerVelocity, delta );\n\n\t// Calculate walk direction\n\tconst angle = controls.getAzimuthalAngle();\n\tconst walkDirection = new THREE.Vector3();\n\tconst directions = [\n\t\t{ key: keys.fwd, vec: [ 0, 0, - 1 ] },\n\t\t{ key: keys.bkd, vec: [ 0, 0, 1 ] },\n\t\t{ key: keys.lft, vec: [ - 1, 0, 0 ] },\n\t\t{ key: keys.rgt, vec: [ 1, 0, 0 ] },\n\t];\n\n\tfor ( const { key, vec } of directions ) {\n\n\t\tif ( key ) {\n\n\t\t\t_tempVector.set( ...vec ).applyAxisAngle( _upVector, angle );\n\t\t\twalkDirection.addScaledVector( _tempVector, params.playerSpeed * delta );\n\n\t\t}\n\n\t}\n\n\t// Update walk animation\n\tconst animationStep = delta * 25;\n\twalkAnimation = ( walkAnimation - animationStep + WALK_CYCLE_TIME ) % WALK_CYCLE_TIME;\n\n\tconst cycle = ( walkAnimation / Math.PI ) % 1;\n\tconst animationOnGround = Math.abs( cycle ) < 2 * animationStep / Math.PI || Math.abs( 1 - cycle ) < 2 * animationStep / Math.PI;\n\tif ( offGroundTimer < 0 && animationOnGround ) {\n\n\t\twalkAnimation = Math.round( walkAnimation / Math.PI ) * Math.PI;\n\n\t}\n\n\t// Apply walk direction\n\tif ( walkDirection.length() > 0 ) {\n\n\t\t_worldSegment.start.add( walkDirection );\n\t\t_worldSegment.end.add( walkDirection );\n\n\t\t// Rotate player to face walk direction\n\t\tconst right = new THREE.Vector3( 1, 0, 0 );\n\t\tconst walkAngle = right.angleTo( walkDirection.normalize() );\n\t\tright.cross( walkDirection );\n\n\t\tconst quat = new THREE.Quaternion().setFromAxisAngle( _upVector, Math.sign( right.y ) * walkAngle );\n\t\tplayer.quaternion.slerp( quat, 1 - ( 2 ** ( - delta / 0.05 ) ) );\n\n\t} else if ( animationOnGround ) {\n\n\t\twalkAnimation = Math.round( walkAnimation / Math.PI ) * Math.PI;\n\n\t}\n\n\t// Apply walk animation to player mesh\n\tplayerMesh.position.y = Math.abs( Math.sin( walkAnimation ) ) * 0.6;\n\tplayerMesh.rotation.x = Math.sin( walkAnimation ) * 0.3;\n\n\t// Get capsule AABB in scene BVH space\n\t_sceneLocalBox.makeEmpty();\n\t_sceneLocalBox.expandByPoint( _worldSegment.start );\n\t_sceneLocalBox.expandByPoint( _worldSegment.end );\n\t_sceneLocalBox.min.addScalar( - capsuleInfo.radius );\n\t_sceneLocalBox.max.addScalar( capsuleInfo.radius );\n\t_sceneLocalBox.applyMatrix4( _invMat );\n\n\tconst segmentStart = _worldSegment.start.clone();\n\tsceneBVH.shapecast( {\n\n\t\tintersectsBounds: box => box.intersectsBox( _sceneLocalBox ),\n\n\t\tintersectsObject: object => {\n\n\t\t\tif ( ! object.visible || object.material.transparent ) {\n\n\t\t\t\treturn;\n\n\t\t\t}\n\n\t\t\t_invMat.copy( object.matrixWorld ).invert();\n\n\t\t\t// Get capsule AABB in object space\n\t\t\t_objectLocalBox.makeEmpty();\n\t\t\t_objectLocalBox.expandByPoint( _worldSegment.start );\n\t\t\t_objectLocalBox.expandByPoint( _worldSegment.end );\n\t\t\t_objectLocalBox.min.addScalar( - capsuleInfo.radius );\n\t\t\t_objectLocalBox.max.addScalar( capsuleInfo.radius );\n\t\t\t_objectLocalBox.applyMatrix4( _invMat );\n\n\t\t\t// Get segment and sphere in local space\n\t\t\t_localSegment.copy( _worldSegment ).applyMatrix4( _invMat );\n\t\t\t_sphere.radius = capsuleInfo.radius;\n\t\t\t_sphere.applyMatrix4( _invMat );\n\t\t\tconst localRadius = _sphere.radius;\n\n\t\t\tobject.geometry.boundsTree.shapecast( {\n\n\t\t\t\tintersectsBounds: box => box.intersectsBox( _objectLocalBox ),\n\n\t\t\t\tintersectsTriangle: tri => {\n\n\t\t\t\t\tconst triPoint = _tempVector;\n\t\t\t\t\tconst capsulePoint = _tempVector2;\n\n\t\t\t\t\tconst distance = tri.closestPointToSegment( _localSegment, triPoint, capsulePoint );\n\t\t\t\t\tif ( distance < localRadius ) {\n\n\t\t\t\t\t\tconst depth = localRadius - distance;\n\t\t\t\t\t\tconst direction = capsulePoint.sub( triPoint ).normalize();\n\t\t\t\t\t\t_localSegment.start.addScaledVector( direction, depth );\n\t\t\t\t\t\t_localSegment.end.addScaledVector( direction, depth );\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t} );\n\n\t\t\t_worldSegment.copy( _localSegment ).applyMatrix4( object.matrixWorld );\n\n\t\t},\n\n\t} );\n\n\t// Update player position\n\tconst deltaVector = _tempVector2;\n\tdeltaVector.copy( capsuleInfo.segment.start ).applyMatrix4( player.matrixWorld );\n\tdeltaVector.subVectors( _worldSegment.start, deltaVector );\n\tplayer.position.add( deltaVector );\n\n\t// Check if player is on ground\n\tdeltaVector.copy( segmentStart ).subVectors( _worldSegment.start, deltaVector );\n\tconst touchingGround = deltaVector.y > Math.abs( delta * _playerVelocity.y * 0.25 );\n\n\tif ( touchingGround ) {\n\n\t\toffGroundTimer = OFF_GROUND_TIME;\n\t\tplayerIsOnGround = true;\n\t\t_playerVelocity.set( 0, 0, 0 );\n\n\t} else {\n\n\t\toffGroundTimer -= delta;\n\t\tplayerIsOnGround = false;\n\t\t_playerVelocity.addScaledVector( deltaVector, - deltaVector.dot( _playerVelocity ) );\n\n\t}\n\n\t// Reset if fallen too far\n\tif ( player.position.y < - 5 ) reset();\n\n}\n\nfunction updateCamera() {\n\n\tcamera.position.sub( controls.target );\n\tcontrols.target.sub( player.position );\n\n\tconst scalar = camera.position.length() * 0.1;\n\tlet heightOffset = controls.target.y;\n\tcontrols.target.y = 0;\n\n\t// Limit horizontal distance\n\tif ( controls.target.length() > 4 * scalar ) {\n\n\t\tcontrols.target.normalize().multiplyScalar( 4 * scalar );\n\n\t}\n\n\t// Clamp height offset\n\theightOffset = Math.max( 1.5 - 0.5 * scalar, Math.min( heightOffset, 1.5 + scalar ) );\n\n\tcontrols.target.y = heightOffset;\n\tcontrols.target.add( player.position );\n\tcamera.position.add( controls.target );\n\n}\n\nfunction render() {\n\n\tstats.update();\n\n\tconst delta = Math.min( clock.getDelta(), 0.1 );\n\n\t// Update controls based on first-person mode\n\tif ( params.firstPerson ) {\n\n\t\tcontrols.maxPolarAngle = Math.PI;\n\t\tcontrols.minDistance = controls.maxDistance = 1e-4;\n\n\t} else {\n\n\t\tcontrols.maxPolarAngle = Math.PI / 2;\n\t\tcontrols.minDistance = 1;\n\t\tcontrols.maxDistance = 20000;\n\n\t}\n\n\tif ( level ) {\n\n\t\tsceneHelper.visible = params.displayBVH;\n\n\t\tconst physicsSteps = params.physicsSteps;\n\t\tfor ( let i = 0; i < physicsSteps; i ++ ) {\n\n\t\t\tupdatePlayer( delta / physicsSteps );\n\n\t\t}\n\n\t}\n\n\tupdateCamera();\n\tcontrols.update();\n\trenderer.render( scene, camera );\n\n}\n"],"names":["params","reset","OFF_GROUND_TIME","WALK_CYCLE_TIME","_playerVelocity","THREE.Vector3","_upVector","_tempVector","_tempVector2","_sceneLocalBox","THREE.Box3","_objectLocalBox","_invMat","THREE.Matrix4","_worldSegment","THREE.Line3","_localSegment","_sphere","THREE.Sphere","renderer","camera","scene","clock","stats","controls","level","player","playerMesh","sceneBVH","sceneHelper","playerIsOnGround","offGroundTimer","walkAnimation","keys","init","render","THREE.WebGLRenderer","THREE.PCFShadowMap","THREE.Scene","THREE.PerspectiveCamera","light","THREE.DirectionalLight","shadowCam","THREE.HemisphereLight","OrbitControls","THREE.Clock","Stats","loadColliderEnvironment","THREE.Group","material","THREE.MeshStandardMaterial","body","THREE.Mesh","RoundedBoxGeometry","arms","head","THREE.SphereGeometry","gui","GUI","v","visFolder","physicsFolder","e","GLTFLoader","res","gltfScene","toRemove","c","_a","child","MeshBVH","ObjectBVH","BVHHelper","updatePlayer","delta","capsuleInfo","angle","walkDirection","directions","key","vec","animationStep","cycle","animationOnGround","right","walkAngle","quat","THREE.Quaternion","segmentStart","box","object","localRadius","tri","triPoint","capsulePoint","distance","depth","direction","deltaVector","updateCamera","scalar","heightOffset","physicsSteps","i"],"mappings":"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"}