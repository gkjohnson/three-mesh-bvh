import{n as Q,Y as E,V as Z,b as ee,an as te,ap as ne,i as W,ad as N,C as se,aw as X,aM as $,J as re,k as oe,W as ie,c as ae,P as ce,M as le,e as pe,f as ue,aN as de}from"./ExtendedTriangle-hsPasuNU.js";/* empty css               */import{S as me}from"./Stats-9dH8FB2H.js";import{O as he}from"./OrbitControls-DEZHvbFX.js";import{g as fe}from"./lil-gui.module.min-BH_YJbPT.js";import{G as ge,P as ye,I as xe,N as we,C as J,S as Pe,A as ve}from"./MeshBVH-DQV6PBDm.js";import{a as Be,c as Ce,d as Te}from"./ExtensionUtilities-BlnM4xb7.js";import{B as Se}from"./BVHHelper-DA_xcAFF.js";const Y=new Q,G=new E,k=new ye(()=>new Z),q=new ee;class Re extends ge{get primitiveStride(){return 1}writePrimitiveBounds(c,l,p){const u=this._indirectBuffer,{geometry:P}=this,m=P.attributes.position,B=P.index;let h=u?u[c]:c;B&&(h=B.getX(h));const H=m.getX(h),x=m.getY(h),V=m.getZ(h);return l[p+0]=H,l[p+1]=x,l[p+2]=V,l[p+3]=H,l[p+4]=x,l[p+5]=V,l}shapecast(c){const l=k.getPrimitive(),p=super.shapecast({...c,intersectsPrimitive:c.intersectsPoint,scratchPrimitive:l,iterate:He});return k.releasePrimitive(l),p}raycastObject3D(c,l,p=[]){const{geometry:u}=this,{matrixWorld:P}=c,{firstHitOnly:m}=l;Y.copy(P).invert(),G.copy(l.ray).applyMatrix4(Y);const h=l.params.Points.threshold/((c.scale.x+c.scale.y+c.scale.z)/3),H=h*h;let x=null,V=1/0;return this.shapecast({boundsTraverseOrder:C=>C.distanceToPoint(G.origin),intersectsBounds:C=>(q.copy(C).expandByScalar(Math.abs(h)),G.intersectsBox(q)?xe:we),intersectsPoint:(C,M)=>{const A=G.distanceSqToPoint(C);if(A<H){const T=new Z;G.closestPointToPoint(C,T),T.applyMatrix4(P);const e=l.ray.origin.distanceTo(T);if(e<l.near||e>l.far||m&&e>=V)return;V=e,M=this.resolvePrimitiveIndex(M),x={distance:e,distanceToRay:Math.sqrt(A),point:T,index:u.index?u.index.getX(M):M,face:null,faceIndex:null,barycoord:null,object:c},m||p.push(x)}}}),m&&x&&p.push(x),p}}function He(z,c,l,p,u,P,m){const{geometry:B}=l,{index:h}=B,H=B.attributes.position;for(let x=z,V=c+z;x<V;x++){const C=l.resolvePrimitiveIndex(x),M=h?h.array[C]:C;if(m.fromBufferAttribute(H,M),p(m,x,u,P))return!0}return!1}const w=new se;class Ve extends te{constructor(c){super(c),this.propertyNameMapping={},this.customPropertyMapping={}}load(c,l,p,u){const P=this,m=new ne(this.manager);m.setPath(this.path),m.setResponseType("arraybuffer"),m.setRequestHeader(this.requestHeader),m.setWithCredentials(this.withCredentials),m.load(c,function(B){try{l(P.parse(B))}catch(h){u?u(h):console.error(h),P.manager.itemError(c)}},p,u)}setPropertyNameMapping(c){this.propertyNameMapping=c}setCustomPropertyNameMapping(c){this.customPropertyMapping=c}parse(c){function l(e,r=0){const n=/^ply([\s\S]*)end_header(\r\n|\r|\n)/;let t="";const s=n.exec(e);s!==null&&(t=s[1]);const o={comments:[],elements:[],headerLength:r,objInfo:""},a=t.split(/\r\n|\r|\n/);let i;function v(f,y){const d={type:f[0]};return d.type==="list"?(d.name=f[3],d.countType=f[1],d.itemType=f[2]):d.name=f[1],d.name in y&&(d.name=y[d.name]),d}for(let f=0;f<a.length;f++){let y=a[f];if(y=y.trim(),y==="")continue;const d=y.split(/\s+/),L=d.shift();switch(y=d.join(" "),L){case"format":o.format=d[0],o.version=d[1];break;case"comment":o.comments.push(y);break;case"element":i!==void 0&&o.elements.push(i),i={},i.name=d[0],i.count=parseInt(d[1]),i.properties=[];break;case"property":i.properties.push(v(d,T.propertyNameMapping));break;case"obj_info":o.objInfo=y;break;default:console.log("unhandled",L,d)}}return i!==void 0&&o.elements.push(i),o}function p(e,r){switch(r){case"char":case"uchar":case"short":case"ushort":case"int":case"uint":case"int8":case"uint8":case"int16":case"uint16":case"int32":case"uint32":return parseInt(e);case"float":case"double":case"float32":case"float64":return parseFloat(e)}}function u(e,r){const n={};for(let t=0;t<e.length;t++){if(r.empty())return null;if(e[t].type==="list"){const s=[],o=p(r.next(),e[t].countType);for(let a=0;a<o;a++){if(r.empty())return null;s.push(p(r.next(),e[t].itemType))}n[e[t].name]=s}else n[e[t].name]=p(r.next(),e[t].type)}return n}function P(){const e={indices:[],vertices:[],normals:[],uvs:[],faceVertexUvs:[],colors:[],faceVertexColors:[]};for(const r of Object.keys(T.customPropertyMapping))e[r]=[];return e}function m(e){const r=e.map(t=>t.name);function n(t){for(let s=0,o=t.length;s<o;s++){const a=t[s];if(r.includes(a))return a}return null}return{attrX:n(["x","px","posx"])||"x",attrY:n(["y","py","posy"])||"y",attrZ:n(["z","pz","posz"])||"z",attrNX:n(["nx","normalx"]),attrNY:n(["ny","normaly"]),attrNZ:n(["nz","normalz"]),attrS:n(["s","u","texture_u","tx"]),attrT:n(["t","v","texture_v","ty"]),attrR:n(["red","diffuse_red","r","diffuse_r"]),attrG:n(["green","diffuse_green","g","diffuse_g"]),attrB:n(["blue","diffuse_blue","b","diffuse_b"])}}function B(e,r){const n=P(),t=/end_header\s+(\S[\s\S]*\S|\S)\s*$/;let s,o;(o=t.exec(e))!==null?s=o[1].split(/\s+/):s=[];const a=new ze(s);e:for(let i=0;i<r.elements.length;i++){const v=r.elements[i],f=m(v.properties);for(let y=0;y<v.count;y++){const d=u(v.properties,a);if(!d)break e;H(n,v.name,d,f)}}return h(n)}function h(e){let r=new W;e.indices.length>0&&r.setIndex(e.indices),r.setAttribute("position",new N(e.vertices,3)),e.normals.length>0&&r.setAttribute("normal",new N(e.normals,3)),e.uvs.length>0&&r.setAttribute("uv",new N(e.uvs,2)),e.colors.length>0&&r.setAttribute("color",new N(e.colors,3)),(e.faceVertexUvs.length>0||e.faceVertexColors.length>0)&&(r=r.toNonIndexed(),e.faceVertexUvs.length>0&&r.setAttribute("uv",new N(e.faceVertexUvs,2)),e.faceVertexColors.length>0&&r.setAttribute("color",new N(e.faceVertexColors,3)));for(const n of Object.keys(T.customPropertyMapping))e[n].length>0&&r.setAttribute(n,new N(e[n],T.customPropertyMapping[n].length));return r.computeBoundingSphere(),r}function H(e,r,n,t){if(r==="vertex"){e.vertices.push(n[t.attrX],n[t.attrY],n[t.attrZ]),t.attrNX!==null&&t.attrNY!==null&&t.attrNZ!==null&&e.normals.push(n[t.attrNX],n[t.attrNY],n[t.attrNZ]),t.attrS!==null&&t.attrT!==null&&e.uvs.push(n[t.attrS],n[t.attrT]),t.attrR!==null&&t.attrG!==null&&t.attrB!==null&&(w.setRGB(n[t.attrR]/255,n[t.attrG]/255,n[t.attrB]/255,X),e.colors.push(w.r,w.g,w.b));for(const s of Object.keys(T.customPropertyMapping))for(const o of T.customPropertyMapping[s])e[s].push(n[o])}else if(r==="face"){const s=n.vertex_indices||n.vertex_index,o=n.texcoord;s.length===3?(e.indices.push(s[0],s[1],s[2]),o&&o.length===6&&(e.faceVertexUvs.push(o[0],o[1]),e.faceVertexUvs.push(o[2],o[3]),e.faceVertexUvs.push(o[4],o[5]))):s.length===4&&(e.indices.push(s[0],s[1],s[3]),e.indices.push(s[1],s[2],s[3])),t.attrR!==null&&t.attrG!==null&&t.attrB!==null&&(w.setRGB(n[t.attrR]/255,n[t.attrG]/255,n[t.attrB]/255,X),e.faceVertexColors.push(w.r,w.g,w.b),e.faceVertexColors.push(w.r,w.g,w.b),e.faceVertexColors.push(w.r,w.g,w.b))}}function x(e,r){const n={};let t=0;for(let s=0;s<r.length;s++){const o=r[s],a=o.valueReader;if(o.type==="list"){const i=[],v=o.countReader.read(e+t);t+=o.countReader.size;for(let f=0;f<v;f++)i.push(a.read(e+t)),t+=a.size;n[o.name]=i}else n[o.name]=a.read(e+t),t+=a.size}return[n,t]}function V(e,r,n){function t(s,o,a){switch(o){case"int8":case"char":return{read:i=>s.getInt8(i),size:1};case"uint8":case"uchar":return{read:i=>s.getUint8(i),size:1};case"int16":case"short":return{read:i=>s.getInt16(i,a),size:2};case"uint16":case"ushort":return{read:i=>s.getUint16(i,a),size:2};case"int32":case"int":return{read:i=>s.getInt32(i,a),size:4};case"uint32":case"uint":return{read:i=>s.getUint32(i,a),size:4};case"float32":case"float":return{read:i=>s.getFloat32(i,a),size:4};case"float64":case"double":return{read:i=>s.getFloat64(i,a),size:8}}}for(let s=0,o=e.length;s<o;s++){const a=e[s];a.type==="list"?(a.countReader=t(r,a.countType,n),a.valueReader=t(r,a.itemType,n)):a.valueReader=t(r,a.type,n)}}function C(e,r){const n=P(),t=r.format==="binary_little_endian",s=new DataView(e,r.headerLength);let o,a=0;for(let i=0;i<r.elements.length;i++){const v=r.elements[i],f=v.properties,y=m(f);V(f,s,t);for(let d=0;d<v.count;d++){o=x(a,f),a+=o[1];const L=o[0];H(n,v.name,L,y)}}return h(n)}function M(e){let r=0,n=!0,t="";const s=[],o=new TextDecoder().decode(e.subarray(0,5)),a=/^ply\r\n/.test(o);do{const i=String.fromCharCode(e[r++]);i!==`
`&&i!=="\r"?t+=i:(t==="end_header"&&(n=!1),t!==""&&(s.push(t),t=""))}while(n&&r<e.length);return a===!0&&r++,{headerText:s.join("\r")+"\r",headerLength:r}}let A;const T=this;if(c instanceof ArrayBuffer){const e=new Uint8Array(c),{headerText:r,headerLength:n}=M(e),t=l(r,n);if(t.format==="ascii"){const s=new TextDecoder().decode(e);A=B(s,t)}else A=C(c,t)}else A=B(c,l(c));return A}}class ze{constructor(c){this.arr=c,this.i=0}empty(){return this.i>=this.arr.length}next(){return this.arr[this.i++]}}$.prototype.raycast=Be;W.prototype.computeBoundsTree=Ce;W.prototype.disposeBoundsTree=Te;const Me="https://raw.githubusercontent.com/gkjohnson/3d-demo-data/main/models/point-cloud-porsche/scene.ply",g={displayBVH:!1,displayDepth:15,displayParents:!1,strategy:J,indirect:!0,pointSize:.005,raycastThreshold:.005,useBVH:!0};let F,O,I,S,b,R,K;const U=new re,j=new oe;j.firstHitOnly=!0;let _;be();function be(){K=document.getElementById("output"),S=new ie({antialias:!0}),S.setPixelRatio(window.devicePixelRatio),S.setSize(window.innerWidth,window.innerHeight),S.setClearColor(1250841,1),S.setAnimationLoop(Ae),document.body.appendChild(S.domElement),O=new ae,I=new ce(75,window.innerWidth/window.innerHeight,.1,100),I.position.set(0,2,4),new he(I,S.domElement),F=new me,document.body.appendChild(F.dom),_=new le(new pe(.025,32,32),new ue({color:16776960,opacity:.9,transparent:!0})),_.visible=!1,O.add(_),new Ve().load(Me,u=>{R=new $(u,new de({size:g.pointSize,vertexColors:!0})),u.computeBoundingBox(),u.boundingBox.getCenter(R.position).multiplyScalar(-1),R.position.y+=1,b=new Se(R,g.displayDepth),O.add(R,b),D()});const c=new fe,l=c.addFolder("BVH");l.add(g,"displayBVH"),l.add(g,"displayParents").onChange(u=>{b.displayParents=u,b.update()}),l.add(g,"displayDepth",1,25,1).name("depth").onChange(u=>{b.depth=u,b.update()}),l.open();const p=c.addFolder("Points");p.add(g,"useBVH").onChange(D),p.add(g,"indirect").onChange(D),p.add(g,"strategy",{CENTER:J,AVERAGE:ve,SAH:Pe}).onChange(D),p.add(g,"pointSize",.001,.01,.001),p.add(g,"raycastThreshold",.001,.01,.001),p.open(),window.addEventListener("resize",()=>{I.aspect=window.innerWidth/window.innerHeight,I.updateProjectionMatrix(),S.setSize(window.innerWidth,window.innerHeight),S.setPixelRatio(window.devicePixelRatio)}),window.addEventListener("pointermove",u=>{U.x=u.clientX/window.innerWidth*2-1,U.y=-(u.clientY/window.innerHeight)*2+1})}function D(){g.useBVH?(console.time("PointsBVH"),R.geometry.computeBoundsTree({strategy:parseInt(g.strategy),indirect:g.indirect,type:Re}),console.timeEnd("PointsBVH")):R.geometry.disposeBoundsTree(),b.update()}function Ae(){if(F.begin(),R){R.material.size=g.pointSize,j.params.Points.threshold=g.raycastThreshold,b.visible=g.displayBVH,j.setFromCamera(U,I);const z=window.performance.now(),l=j.intersectObject(R)[0];l?(_.position.copy(l.point),_.visible=!0):_.visible=!1;const p=window.performance.now()-z;K.innerText=`${p.toFixed(2)}ms`}S.render(O,I),F.end()}
//# sourceMappingURL=pointCloudIntersection-DsaLdpRi.js.map
