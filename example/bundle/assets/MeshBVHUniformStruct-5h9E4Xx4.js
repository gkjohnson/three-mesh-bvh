import{aS as w,F as E,$ as x,aT as F,aU as B,aV as z,aW as G,aX as R,aY as V,a0 as U,aZ as M,a_ as N,a$ as L,b0 as k,R as D,B as O}from"./ExtendedTriangle-hsPasuNU.js";import{g as Y,b as P,d as b,f as X,h as q,O as H,j as W,k as Z,L as $}from"./MeshBVH-DQV6PBDm.js";function j(c){switch(c){case 1:return"R";case 2:return"RG";case 3:return"RGBA";case 4:return"RGBA"}throw new Error}function K(c){switch(c){case 1:return D;case 2:return k;case 3:return U;case 4:return U}}function T(c){switch(c){case 1:return L;case 2:return N;case 3:return M;case 4:return M}}class v extends x{constructor(){super(),this.minFilter=F,this.magFilter=F,this.generateMipmaps=!1,this.overrideItemSize=null,this._forcedType=null}updateFrom(e){const t=this.overrideItemSize,d=e.itemSize,r=e.count;if(t!==null){if(d*r%t!==0)throw new Error("VertexAttributeTexture: overrideItemSize must divide evenly into buffer length.");e.itemSize=t,e.count=r*d/t}const n=e.itemSize,y=e.count,A=e.normalized,l=e.array.constructor,i=l.BYTES_PER_ELEMENT;let u=this._forcedType,f=n;if(u===null)switch(l){case Float32Array:u=E;break;case Uint8Array:case Uint16Array:case Uint32Array:u=w;break;case Int8Array:case Int16Array:case Int32Array:u=B;break}let s,a,h,m,p=j(n);switch(u){case E:h=1,a=K(n),A&&i===1?(m=l,p+="8",l===Uint8Array?s=z:(s=R,p+="_SNORM")):(m=Float32Array,p+="32F",s=E);break;case B:p+=i*8+"I",h=A?Math.pow(2,l.BYTES_PER_ELEMENT*8-1):1,a=T(n),i===1?(m=Int8Array,s=R):i===2?(m=Int16Array,s=V):(m=Int32Array,s=B);break;case w:p+=i*8+"UI",h=A?Math.pow(2,l.BYTES_PER_ELEMENT*8-1):1,a=T(n),i===1?(m=Uint8Array,s=z):i===2?(m=Uint16Array,s=G):(m=Uint32Array,s=w);break}f===3&&(a===U||a===M)&&(f=4);const o=Math.ceil(Math.sqrt(y))||1,_=f*o*o,g=new m(_),C=e.normalized;e.normalized=!1;for(let I=0;I<y;I++){const S=f*I;g[S]=e.getX(I)/h,n>=2&&(g[S+1]=e.getY(I)/h),n>=3&&(g[S+2]=e.getZ(I)/h,f===4&&(g[S+3]=1)),n>=4&&(g[S+3]=e.getW(I)/h)}e.normalized=C,this.internalFormat=p,this.format=a,this.type=s,this.image.width=o,this.image.height=o,this.image.data=g,this.needsUpdate=!0,this.dispose(),e.itemSize=d,e.count=r}}class J extends v{constructor(){super(),this._forcedType=w}}class Q extends v{constructor(){super(),this._forcedType=E}}class ne{constructor(){this.index=new J,this.position=new Q,this.bvhBounds=new x,this.bvhContents=new x,this._cachedIndexAttr=null,this.index.overrideItemSize=3}updateFrom(e){const{geometry:t}=e;if(te(e,this.bvhBounds,this.bvhContents),this.position.updateFrom(t.attributes.position),e.indirect){const d=e._indirectBuffer;if(this._cachedIndexAttr===null||this._cachedIndexAttr.count!==d.length)if(t.index)this._cachedIndexAttr=t.index.clone();else{const r=Y(P(t));this._cachedIndexAttr=new O(r,1,!1)}ee(t,d,this._cachedIndexAttr),this.index.updateFrom(this._cachedIndexAttr)}else this.index.updateFrom(t.index)}dispose(){const{index:e,position:t,bvhBounds:d,bvhContents:r}=this;e&&e.dispose(),t&&t.dispose(),d&&d.dispose(),r&&r.dispose()}}function ee(c,e,t){const d=t.array,r=c.index?c.index.array:null;for(let n=0,y=e.length;n<y;n++){const A=3*n,l=3*e[n];for(let i=0;i<3;i++)d[A+i]=r?r[l+i]:l+i}}function te(c,e,t){const d=c._roots;if(d.length!==1)throw new Error("MeshBVHUniformStruct: Multi-root BVHs not supported.");const r=d[0],n=new Uint16Array(r),y=new Uint32Array(r),A=new Float32Array(r),l=r.byteLength/b,i=2*Math.ceil(Math.sqrt(l/2)),u=new Float32Array(4*i*i),f=Math.ceil(Math.sqrt(l)),s=new Uint32Array(2*f*f);for(let a=0;a<l;a++){const h=a*b/4,m=h*2,p=Z(h);for(let o=0;o<3;o++)u[8*a+0+o]=A[p+0+o],u[8*a+4+o]=A[p+3+o];if(X(m,n)){const o=q(m,n),_=H(h,y),g=$|o;s[a*2+0]=g,s[a*2+1]=_}else{const o=y[h+6],_=W(h,y);s[a*2+0]=_,s[a*2+1]=o}}e.image.data=u,e.image.width=i,e.image.height=i,e.format=U,e.type=E,e.internalFormat="RGBA32F",e.minFilter=F,e.magFilter=F,e.generateMipmaps=!1,e.needsUpdate=!0,e.dispose(),t.image.data=s,t.image.width=f,t.image.height=f,t.format=N,t.type=w,t.internalFormat="RG32UI",t.minFilter=F,t.magFilter=F,t.generateMipmaps=!1,t.needsUpdate=!0,t.dispose()}export{Q as F,ne as M};
//# sourceMappingURL=MeshBVHUniformStruct-5h9E4Xx4.js.map
