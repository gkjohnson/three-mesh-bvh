{"version":3,"file":"gpuPathTracingSimple-CC5uhGIe.js","sources":["../../gpuPathTracingSimple.js"],"sourcesContent":["import * as THREE from 'three';\nimport { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';\nimport { FullScreenQuad } from 'three/examples/jsm/postprocessing/Pass.js';\nimport Stats from 'stats.js';\nimport { GUI } from 'three/examples/jsm/libs/lil-gui.module.min.js';\nimport {\n\tMeshBVH, MeshBVHUniformStruct, FloatVertexAttributeTexture,\n\tBVHShaderGLSL, SAH,\n} from 'three-mesh-bvh';\n\nconst params = {\n\tenableRaytracing: true,\n\tanimate: true,\n\tresolutionScale: 1.0 / window.devicePixelRatio,\n\tsmoothNormals: true,\n};\n\nlet renderer, camera, scene, gui, stats;\nlet rtQuad, mesh, clock;\n\ninit();\nrender();\n\nfunction init() {\n\n\t// renderer setup\n\trenderer = new THREE.WebGLRenderer( { antialias: false } );\n\trenderer.setPixelRatio( window.devicePixelRatio );\n\trenderer.setClearColor( 0x09141a );\n\trenderer.setSize( window.innerWidth, window.innerHeight );\n\trenderer.outputEncoding = THREE.sRGBEncoding;\n\tdocument.body.appendChild( renderer.domElement );\n\n\t// scene setup\n\tscene = new THREE.Scene();\n\n\tconst light = new THREE.DirectionalLight( 0xffffff, 1 );\n\tlight.position.set( 1, 1, 1 );\n\tscene.add( light );\n\tscene.add( new THREE.AmbientLight( 0xb0bec5, 0.5 ) );\n\n\t// camera setup\n\tcamera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 50 );\n\tcamera.position.set( 0, 0, 4 );\n\tcamera.far = 100;\n\tcamera.updateProjectionMatrix();\n\n\t// stats setup\n\tstats = new Stats();\n\tdocument.body.appendChild( stats.dom );\n\n\tconst knotGeometry = new THREE.TorusKnotGeometry( 1, 0.3, 300, 50 );\n\tconst bvh = new MeshBVH( knotGeometry, { maxLeafSize: 1, strategy: SAH } );\n\n\tmesh = new THREE.Mesh( knotGeometry, new THREE.MeshStandardMaterial() );\n\tscene.add( mesh );\n\n\tclock = new THREE.Clock();\n\n\tconst rtMaterial = new THREE.ShaderMaterial( {\n\n\t\tdefines: {\n\n\t\t\tSMOOTH_NORMALS: 1,\n\n\t\t},\n\n\t\tuniforms: {\n\t\t\tbvh: { value: new MeshBVHUniformStruct() },\n\t\t\tnormalAttribute: { value: new FloatVertexAttributeTexture() },\n\t\t\tcameraWorldMatrix: { value: new THREE.Matrix4() },\n\t\t\tinvProjectionMatrix: { value: new THREE.Matrix4() },\n\t\t\tinvModelMatrix: { value: new THREE.Matrix4() },\n\t\t},\n\n\t\tvertexShader: /* glsl */`\n\n\t\t\tvarying vec2 vUv;\n\t\t\tvoid main() {\n\n\t\t\t\tvec4 mvPosition = vec4( position, 1.0 );\n\t\t\t\tmvPosition = modelViewMatrix * mvPosition;\n\t\t\t\tgl_Position = projectionMatrix * mvPosition;\n\n\t\t\t\tvUv = uv;\n\n\t\t\t}\n\n\t\t`,\n\n\t\tfragmentShader: /* glsl */`\n\t\t\tprecision highp isampler2D;\n\t\t\tprecision highp usampler2D;\n\n\t\t\t${ BVHShaderGLSL.common_functions }\n\t\t\t${ BVHShaderGLSL.bvh_struct_definitions }\n\t\t\t${ BVHShaderGLSL.bvh_ray_functions }\n\n\t\t\tuniform mat4 cameraWorldMatrix;\n\t\t\tuniform mat4 invProjectionMatrix;\n\t\t\tuniform mat4 invModelMatrix;\n\t\t\tuniform sampler2D normalAttribute;\n\t\t\tuniform BVH bvh;\n\t\t\tvarying vec2 vUv;\n\n\t\t\tvoid main() {\n\n\t\t\t\t// get [-1, 1] normalized device coordinates\n\t\t\t\tvec2 ndc = 2.0 * vUv - vec2( 1.0 );\n\t\t\t\tvec3 rayOrigin, rayDirection;\n\t\t\t\tndcToCameraRay(\n\t\t\t\t\tndc, invModelMatrix * cameraWorldMatrix, invProjectionMatrix,\n\t\t\t\t\trayOrigin, rayDirection\n\t\t\t\t);\n\n\t\t\t\t// hit results\n\t\t\t\tuvec4 faceIndices = uvec4( 0u );\n\t\t\t\tvec3 faceNormal = vec3( 0.0, 0.0, 1.0 );\n\t\t\t\tvec3 barycoord = vec3( 0.0 );\n\t\t\t\tfloat side = 1.0;\n\t\t\t\tfloat dist = 0.0;\n\n\t\t\t\t// get intersection\n\t\t\t\tbool didHit = bvhIntersectFirstHit( bvh, rayOrigin, rayDirection, faceIndices, faceNormal, barycoord, side, dist );\n\n\t\t\t\t#if SMOOTH_NORMALS\n\n\t\t\t\t\tvec3 normal = textureSampleBarycoord(\n\t\t\t\t\t\tnormalAttribute,\n\t\t\t\t\t\tbarycoord,\n\t\t\t\t\t\tfaceIndices.xyz\n\t\t\t\t\t).xyz;\n\n\t\t\t\t#else\n\n\t\t\t\t\tvec3 normal = face.normal;\n\n\t\t\t\t#endif\n\n\t\t\t\t// set the color\n\t\t\t\tgl_FragColor = ! didHit ? vec4( 0.0366, 0.0813, 0.1057, 1.0 ) : vec4( normal, 1.0 );\n\n\t\t\t}\n\t\t`\n\n\t} );\n\n\trtQuad = new FullScreenQuad( rtMaterial );\n\trtMaterial.uniforms.bvh.value.updateFrom( bvh );\n\trtMaterial.uniforms.normalAttribute.value.updateFrom( knotGeometry.attributes.normal );\n\n\tnew OrbitControls( camera, renderer.domElement );\n\n\tgui = new GUI();\n\tgui.add( params, 'enableRaytracing' );\n\tgui.add( params, 'animate' );\n\tgui.add( params, 'smoothNormals' ).onChange( v => {\n\n\t\trtQuad.material.defines.SMOOTH_NORMALS = Number( v );\n\t\trtQuad.material.needsUpdate = true;\n\n\t} );\n\tgui.add( params, 'resolutionScale', 0.1, 1, 0.01 ).onChange( resize );\n\tgui.open();\n\n\twindow.addEventListener( 'resize', resize, false );\n\tresize();\n\n}\n\nfunction resize() {\n\n\tcamera.aspect = window.innerWidth / window.innerHeight;\n\tcamera.updateProjectionMatrix();\n\n\tconst w = window.innerWidth;\n\tconst h = window.innerHeight;\n\tconst dpr = window.devicePixelRatio * params.resolutionScale;\n\trenderer.setSize( w, h );\n\trenderer.setPixelRatio( dpr );\n\n}\n\nfunction render() {\n\n\tstats.update();\n\trequestAnimationFrame( render );\n\n\tconst delta = clock.getDelta();\n\tif ( params.animate ) {\n\n\t\tmesh.rotation.y += delta;\n\n\t}\n\n\tif ( params.enableRaytracing ) {\n\n\t\tcamera.updateMatrixWorld();\n\t\tmesh.updateMatrixWorld();\n\n\t\t// update material\n\t\tconst uniforms = rtQuad.material.uniforms;\n\t\tuniforms.cameraWorldMatrix.value.copy( camera.matrixWorld );\n\t\tuniforms.invProjectionMatrix.value.copy( camera.projectionMatrixInverse );\n\t\tuniforms.invModelMatrix.value.copy( mesh.matrixWorld ).invert();\n\n\t\t// render float target\n\t\trtQuad.render( renderer );\n\n\t} else {\n\n\t\trenderer.render( scene, camera );\n\n\t}\n\n}\n"],"names":["params","renderer","camera","scene","gui","stats","rtQuad","mesh","clock","init","render","THREE.WebGLRenderer","THREE.sRGBEncoding","THREE.Scene","light","THREE.DirectionalLight","THREE.AmbientLight","THREE.PerspectiveCamera","Stats","knotGeometry","THREE.TorusKnotGeometry","bvh","MeshBVH","SAH","THREE.Mesh","THREE.MeshStandardMaterial","THREE.Clock","rtMaterial","THREE.ShaderMaterial","MeshBVHUniformStruct","FloatVertexAttributeTexture","THREE.Matrix4","BVHShaderGLSL.common_functions","BVHShaderGLSL.bvh_struct_definitions","BVHShaderGLSL.bvh_ray_functions","FullScreenQuad","OrbitControls","GUI","v","resize","w","h","dpr","delta","uniforms"],"mappings":"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"}