{"version":3,"file":"skinnedMesh-DTcP5Pl5.js","sources":["../../src/bvh/SkinnedMeshBVH.js","../../skinnedMesh.js"],"sourcesContent":["import { Vector3, Vector2, Ray, Matrix4, FrontSide, BackSide, Triangle, SkinnedMesh } from 'three';\nimport { GeometryBVH, ExtendedTriangle, INTERSECTED, NOT_INTERSECTED, SKIP_GENERATION } from 'three-mesh-bvh';\n\nconst _v0 = /* @__PURE__ */ new Vector3();\nconst _v1 = /* @__PURE__ */ new Vector3();\nconst _v2 = /* @__PURE__ */ new Vector3();\nconst _ray = /* @__PURE__ */ new Ray();\nconst _inverseMatrix = /* @__PURE__ */ new Matrix4();\nconst _localPoint = /* @__PURE__ */ new Vector3();\nconst _axes = [ 'x', 'y', 'z' ];\n\nconst _raycast = SkinnedMesh.prototype.raycast;\nexport const skinnedMeshAcceleratedRaycast = function ( raycaster, intersects ) {\n\n\tif ( this.boundsTree ) {\n\n\t\tthis.boundsTree.raycastObject3D( this, raycaster, intersects );\n\n\t} else {\n\n\t\t_raycast.call( this, raycaster, intersects );\n\n\t}\n\n};\n\nexport class SkinnedMeshBVH extends GeometryBVH {\n\n\tget primitiveStride() {\n\n\t\treturn 3;\n\n\t}\n\n\tconstructor( mesh, options = {} ) {\n\n\t\tif ( ! mesh.isMesh ) {\n\n\t\t\tthrow new Error( 'SkinnedMeshBVH: First argument must be a Mesh.' );\n\n\t\t}\n\n\t\t// skip generation initially so we can add our local fields\n\t\t// TODO: is there a more clean way to handle this? Update all subclasses to be\n\t\t// responsible for calling \"init\" themselves?\n\t\tsuper( mesh.geometry, {\n\t\t\t...options,\n\t\t\t[ SKIP_GENERATION ]: true,\n\t\t} );\n\t\tthis.mesh = mesh;\n\n\t\tif ( ! options[ SKIP_GENERATION ] ) {\n\n\t\t\tthis.init( options );\n\n\t\t}\n\n\t}\n\n\twritePrimitiveBounds( i, targetBuffer, baseIndex ) {\n\n\t\tconst { mesh, geometry } = this;\n\t\tconst indirectBuffer = this._indirectBuffer;\n\t\tconst index = geometry.index ? geometry.index.array : null;\n\n\t\tconst tri = indirectBuffer ? indirectBuffer[ i ] : i;\n\t\tconst tri3 = tri * 3;\n\n\t\tlet ai = tri3 + 0;\n\t\tlet bi = tri3 + 1;\n\t\tlet ci = tri3 + 2;\n\n\t\tif ( index ) {\n\n\t\t\tai = index[ ai ];\n\t\t\tbi = index[ bi ];\n\t\t\tci = index[ ci ];\n\n\t\t}\n\n\t\t// Get skinned vertex positions\n\t\tmesh.getVertexPosition( ai, _v0 );\n\t\tmesh.getVertexPosition( bi, _v1 );\n\t\tmesh.getVertexPosition( ci, _v2 );\n\n\t\t// Compute bounds for each axis\n\t\tfor ( let el = 0; el < 3; el ++ ) {\n\n\t\t\tconst axis = _axes[ el ];\n\t\t\tconst a = _v0[ axis ];\n\t\t\tconst b = _v1[ axis ];\n\t\t\tconst c = _v2[ axis ];\n\n\t\t\tlet min = a;\n\t\t\tif ( b < min ) min = b;\n\t\t\tif ( c < min ) min = c;\n\n\t\t\tlet max = a;\n\t\t\tif ( b > max ) max = b;\n\t\t\tif ( c > max ) max = c;\n\n\t\t\t// Write in min/max format [minx, miny, minz, maxx, maxy, maxz]\n\t\t\ttargetBuffer[ baseIndex + el ] = min;\n\t\t\ttargetBuffer[ baseIndex + el + 3 ] = max;\n\n\t\t}\n\n\t\treturn targetBuffer;\n\n\t}\n\n\tshapecast( callbacks ) {\n\n\t\tconst triangle = new ExtendedTriangle();\n\t\treturn super.shapecast(\n\t\t\t{\n\t\t\t\t...callbacks,\n\t\t\t\tintersectsPrimitive: callbacks.intersectsTriangle,\n\t\t\t\tscratchPrimitive: triangle,\n\t\t\t\titerate: iterateOverTriangles,\n\t\t\t},\n\t\t);\n\n\t}\n\n\traycastObject3D( object, raycaster, intersects = [] ) {\n\n\t\tconst { material } = object;\n\t\tif ( material === undefined ) {\n\n\t\t\treturn;\n\n\t\t}\n\n\t\tconst { matrixWorld } = object;\n\t\tconst { firstHitOnly } = raycaster;\n\n\t\t_inverseMatrix.copy( matrixWorld ).invert();\n\t\t_ray.copy( raycaster.ray ).applyMatrix4( _inverseMatrix );\n\n\t\tlet closestHit = null;\n\t\tlet closestDistance = Infinity;\n\n\t\tthis.shapecast( {\n\t\t\tboundsTraverseOrder: box => {\n\n\t\t\t\treturn box.distanceToPoint( _ray.origin );\n\n\t\t\t},\n\t\t\tintersectsBounds: box => {\n\n\t\t\t\treturn _ray.intersectsBox( box ) ? INTERSECTED : NOT_INTERSECTED;\n\n\t\t\t},\n\t\t\tintersectsTriangle: ( tri, triIndex ) => {\n\n\t\t\t\t// get the intersection\n\t\t\t\tlet point = null;\n\t\t\t\tif ( material.side === FrontSide ) {\n\n\t\t\t\t\tpoint = _ray.intersectTriangle( tri.a, tri.b, tri.c, true, _localPoint );\n\n\t\t\t\t} else if ( material.side === BackSide ) {\n\n\t\t\t\t\tpoint = _ray.intersectTriangle( tri.c, tri.b, tri.a, true, _localPoint );\n\n\t\t\t\t} else {\n\n\t\t\t\t\tpoint = _ray.intersectTriangle( tri.a, tri.b, tri.c, false, _localPoint );\n\n\t\t\t\t}\n\n\t\t\t\tif ( ! point ) {\n\n\t\t\t\t\treturn;\n\n\t\t\t\t}\n\n\t\t\t\t// transform it into world space\n\t\t\t\tpoint = point.clone().applyMatrix4( matrixWorld );\n\n\t\t\t\t// check distance to ray\n\t\t\t\tconst dist = raycaster.ray.origin.distanceTo( point );\n\t\t\t\tif ( dist >= raycaster.near && dist <= raycaster.far ) {\n\n\t\t\t\t\tif ( firstHitOnly && dist >= closestDistance ) {\n\n\t\t\t\t\t\treturn;\n\n\t\t\t\t\t}\n\n\t\t\t\t\t// get the vertex indices\n\t\t\t\t\tconst { geometry } = this;\n\t\t\t\t\tconst { index } = geometry;\n\t\t\t\t\tconst actualTri = this.resolvePrimitiveIndex( triIndex );\n\t\t\t\t\tconst triOffset = actualTri * 3;\n\n\t\t\t\t\tlet ai = triOffset + 0;\n\t\t\t\t\tlet bi = triOffset + 1;\n\t\t\t\t\tlet ci = triOffset + 2;\n\n\t\t\t\t\tif ( index ) {\n\n\t\t\t\t\t\tai = index.array[ ai ];\n\t\t\t\t\t\tbi = index.array[ bi ];\n\t\t\t\t\t\tci = index.array[ ci ];\n\n\t\t\t\t\t}\n\n\t\t\t\t\t// calculate barycentric coordinates\n\t\t\t\t\tconst barycoord = new Vector3();\n\t\t\t\t\tTriangle.getBarycoord( _localPoint, tri.a, tri.b, tri.c, barycoord );\n\n\t\t\t\t\t// build the intersection result\n\t\t\t\t\tconst hit = {\n\t\t\t\t\t\tdistance: dist,\n\t\t\t\t\t\tpoint: point.clone(),\n\t\t\t\t\t\tobject,\n\t\t\t\t\t\tbarycoord,\n\t\t\t\t\t\tuv: null,\n\t\t\t\t\t\tuv1: null,\n\t\t\t\t\t\tnormal: null,\n\t\t\t\t\t\tface: {\n\t\t\t\t\t\t\ta: ai,\n\t\t\t\t\t\t\tb: bi,\n\t\t\t\t\t\t\tc: ci,\n\t\t\t\t\t\t\tnormal: Triangle.getNormal( tri.a, tri.b, tri.c, new Vector3() ),\n\t\t\t\t\t\t\tmaterialIndex: 0\n\t\t\t\t\t\t},\n\t\t\t\t\t\tfaceIndex: ai,\n\t\t\t\t\t};\n\n\t\t\t\t\t// add attribute fields if available\n\t\t\t\t\tconst uv = geometry.attributes.uv;\n\t\t\t\t\tconst uv1 = geometry.attributes.uv1;\n\t\t\t\t\tconst normal = geometry.attributes.normal;\n\n\t\t\t\t\tif ( uv ) {\n\n\t\t\t\t\t\thit.uv = Triangle.getInterpolatedAttribute( uv, ai, bi, ci, barycoord, new Vector2() );\n\n\t\t\t\t\t}\n\n\t\t\t\t\tif ( uv1 ) {\n\n\t\t\t\t\t\thit.uv1 = Triangle.getInterpolatedAttribute( uv1, ai, bi, ci, barycoord, new Vector2() );\n\n\t\t\t\t\t}\n\n\t\t\t\t\tif ( normal ) {\n\n\t\t\t\t\t\thit.normal = Triangle.getInterpolatedAttribute( normal, ai, bi, ci, barycoord, new Vector3() );\n\n\t\t\t\t\t\tif ( hit.normal.dot( _ray.direction ) > 0 ) {\n\n\t\t\t\t\t\t\thit.normal.multiplyScalar( - 1 );\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\n\t\t\t\t\t// first hit only settings\n\t\t\t\t\tclosestDistance = hit.distance;\n\t\t\t\t\tclosestHit = hit;\n\n\t\t\t\t\tif ( ! firstHitOnly ) {\n\n\t\t\t\t\t\tintersects.push( hit );\n\n\t\t\t\t\t}\n\n\t\t\t\t}\n\n\t\t\t}\n\t\t} );\n\n\t\tif ( firstHitOnly && closestHit ) {\n\n\t\t\tintersects.push( closestHit );\n\n\t\t}\n\n\t\treturn intersects;\n\n\t}\n\n}\n\nfunction iterateOverTriangles(\n\toffset,\n\tcount,\n\tbvh,\n\tintersectsTriangleFunc,\n\tcontained,\n\tdepth,\n\ttriangle\n) {\n\n\tconst { mesh, geometry } = bvh;\n\tconst index = geometry.index ? geometry.index.array : null;\n\n\tfor ( let i = offset, l = count + offset; i < l; i ++ ) {\n\n\t\tconst tri = bvh.resolvePrimitiveIndex( i );\n\n\t\tlet i0 = 3 * tri + 0;\n\t\tlet i1 = 3 * tri + 1;\n\t\tlet i2 = 3 * tri + 2;\n\n\t\tif ( index ) {\n\n\t\t\ti0 = index[ i0 ];\n\t\t\ti1 = index[ i1 ];\n\t\t\ti2 = index[ i2 ];\n\n\t\t}\n\n\t\tmesh.getVertexPosition( i0, triangle.a );\n\t\tmesh.getVertexPosition( i1, triangle.b );\n\t\tmesh.getVertexPosition( i2, triangle.c );\n\t\ttriangle.needsUpdate = true;\n\n\t\tif ( intersectsTriangleFunc( triangle, i, contained, depth ) ) {\n\n\t\t\treturn true;\n\n\t\t}\n\n\t}\n\n\treturn false;\n\n}\n","import * as THREE from 'three';\nimport { GLTFLoader } from 'three/examples/jsm/loaders/GLTFLoader.js';\nimport Stats from 'stats.js';\nimport { GUI } from 'three/examples/jsm/libs/lil-gui.module.min.js';\nimport { BVHHelper, getBVHExtremes } from 'three-mesh-bvh';\nimport { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';\nimport { SkinnedMeshBVH, skinnedMeshAcceleratedRaycast } from './src/bvh/SkinnedMeshBVH.js';\n\nconst params = {\n\tskeletonHelper: false,\n\tbvhHelper: true,\n\tbvhHelperDepth: 10,\n\n\tautoUpdate: true,\n\tpause: false,\n\trefit: () => refitBVH(),\n\tbvhRaycast: true,\n};\n\nlet renderer, camera, scene, clock, gui, stats;\nlet outputContainer;\nlet controls, mixer, animationAction, model;\nlet skeletonHelper;\nlet initialScore = 0;\nlet bvhs = [], helpers = [];\nlet raycaster, mouse, sphereCollision;\n\ninit();\n\nfunction init() {\n\n\tconst bgColor = 0x111111;\n\n\toutputContainer = document.getElementById( 'output' );\n\n\t// renderer setup\n\trenderer = new THREE.WebGLRenderer( { antialias: true } );\n\trenderer.setPixelRatio( window.devicePixelRatio );\n\trenderer.setSize( window.innerWidth, window.innerHeight );\n\trenderer.setClearColor( bgColor, 1 );\n\trenderer.setAnimationLoop( render );\n\trenderer.shadowMap.enabled = true;\n\trenderer.shadowMap.type = THREE.PCFShadowMap;\n\tdocument.body.appendChild( renderer.domElement );\n\n\t// scene setup\n\tscene = new THREE.Scene();\n\n\tconst light = new THREE.DirectionalLight( 0xffffff, 3 );\n\tlight.position.set( 5, 5, 2.5 );\n\tlight.shadow.mapSize.setScalar( 1024 );\n\tlight.shadow.normalBias = 1e-2;\n\tlight.castShadow = true;\n\n\tconst shadowCam = light.shadow.camera;\n\tshadowCam.left = shadowCam.bottom = - 7.5;\n\tshadowCam.right = shadowCam.top = 7.5;\n\tshadowCam.updateProjectionMatrix();\n\tscene.add( light );\n\tscene.add( new THREE.AmbientLight( 0xb0bec5, 2.4 ) );\n\n\t// camera setup\n\tcamera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 50 );\n\tcamera.position.set( 10, 0, 0 );\n\tcamera.far = 100;\n\tcamera.updateProjectionMatrix();\n\n\tcontrols = new OrbitControls( camera, renderer.domElement );\n\n\tclock = new THREE.Clock();\n\n\t// stats setup\n\tstats = new Stats();\n\tdocument.body.appendChild( stats.dom );\n\n\t// raycaster setup\n\traycaster = new THREE.Raycaster();\n\traycaster.firstHitOnly = true;\n\tmouse = new THREE.Vector2();\n\n\t// collision sphere\n\tconst sphereGeometry = new THREE.SphereGeometry( 0.05, 32, 32 );\n\tconst sphereMaterial = new THREE.MeshBasicMaterial( { color: 0xffff00, opacity: 0.5, transparent: true } );\n\tsphereCollision = new THREE.Mesh( sphereGeometry, sphereMaterial );\n\tsphereCollision.visible = false;\n\tscene.add( sphereCollision );\n\n\t// load the model\n\tnew GLTFLoader()\n\t\t.load( 'https://raw.githubusercontent.com/gkjohnson/3d-demo-data/main/models/trex/scene.gltf', gltf => {\n\n\t\t\t// prep the model and add it to the scene\n\t\t\tmodel = gltf.scene;\n\t\t\tmodel.traverse( object => {\n\n\t\t\t\tif ( object.isMesh ) {\n\n\t\t\t\t\tobject.castShadow = true;\n\t\t\t\t\tobject.receiveShadow = true;\n\t\t\t\t\tobject.frustumCulled = false;\n\n\t\t\t\t\tconst bvh = new SkinnedMeshBVH( object );\n\t\t\t\t\tconst helper = new BVHHelper( object, bvh, params.bvhHelperDepth );\n\t\t\t\t\thelper.update();\n\t\t\t\t\tscene.add( helper );\n\t\t\t\t\tbvhs.push( bvh );\n\t\t\t\t\thelpers.push( helper );\n\n\t\t\t\t\tobject.boundsTree = bvh;\n\n\t\t\t\t}\n\n\t\t\t} );\n\n\t\t\tmodel.updateMatrixWorld( true );\n\t\t\tscene.add( model );\n\n\t\t\t// skeleton helper\n\t\t\tskeletonHelper = new THREE.SkeletonHelper( model );\n\t\t\tskeletonHelper.visible = false;\n\t\t\tscene.add( skeletonHelper );\n\n\t\t\t// animations\n\t\t\tconst animations = gltf.animations;\n\t\t\tmixer = new THREE.AnimationMixer( model );\n\n\t\t\tanimationAction = mixer.clipAction( animations[ 0 ] );\n\t\t\tanimationAction.play();\n\t\t\tanimationAction.paused = params.pause;\n\n\t\t\t// camera setup\n\t\t\tconst box = new THREE.Box3();\n\t\t\tbox.setFromObject( model );\n\t\t\tbox.getCenter( controls.target );\n\t\t\tcontrols.target.z += 3;\n\n\t\t\tcamera.position.copy( controls.target );\n\t\t\tcamera.position.x += 6.5;\n\t\t\tcamera.position.y += 2.5;\n\t\t\tcamera.position.z += 6.5;\n\t\t\tcontrols.update();\n\n\t\t\tinitialScore = calculateScore( bvhs );\n\n\t\t} );\n\n\n\tconst plane = new THREE.Mesh( new THREE.PlaneGeometry(), new THREE.ShadowMaterial( { color: 0xffffff, opacity: 0.025, transparent: true } ) );\n\tplane.rotation.x = - Math.PI / 2;\n\tplane.receiveShadow = true;\n\tplane.scale.setScalar( 50 );\n\tscene.add( plane );\n\n\tgui = new GUI();\n\tgui.add( params, 'pause' ).onChange( v => {\n\n\t\tif ( animationAction ) {\n\n\t\t\tanimationAction.paused = v;\n\n\t\t}\n\n\t} );\n\n\tconst helperFolder = gui.addFolder( 'helpers' );\n\thelperFolder.add( params, 'skeletonHelper' );\n\thelperFolder.add( params, 'bvhHelper' );\n\thelperFolder.add( params, 'bvhHelperDepth', 1, 20, 1 ).onChange( v => {\n\n\t\thelpers.forEach( helper => {\n\n\t\t\thelper.depth = parseInt( v );\n\t\t\thelper.update();\n\n\t\t} );\n\n\t} );\n\thelperFolder.open();\n\n\tconst bvhFolder = gui.addFolder( 'bvh' );\n\tbvhFolder.add( params, 'bvhRaycast' );\n\tbvhFolder.add( params, 'autoUpdate' );\n\tbvhFolder.add( params, 'refit' );\n\tbvhFolder.open();\n\tgui.open();\n\n\twindow.addEventListener( 'resize', function () {\n\n\t\tcamera.aspect = window.innerWidth / window.innerHeight;\n\t\tcamera.updateProjectionMatrix();\n\n\t\trenderer.setSize( window.innerWidth, window.innerHeight );\n\n\t}, false );\n\n\twindow.addEventListener( 'pointermove', function ( e ) {\n\n\t\tmouse.x = ( e.clientX / window.innerWidth ) * 2 - 1;\n\t\tmouse.y = - ( e.clientY / window.innerHeight ) * 2 + 1;\n\n\t}, false );\n\n}\n\n// refit the BVH to match the current skeleton pose\nfunction refitBVH() {\n\n\tlet refitTime;\n\tconst start = performance.now();\n\tbvhs.forEach( bvh => {\n\n\t\tbvh.refit();\n\n\t} );\n\n\trefitTime = performance.now() - start;\n\n\thelpers.forEach( helper => {\n\n\t\thelper.update();\n\n\t} );\n\n\tconst score = calculateScore( bvhs );\n\tconst degradation = ( score / initialScore ) - 1.0;\n\toutputContainer.innerHTML =\n\t\t`refit time: ${ refitTime.toFixed( 2 ) } ms\\n` +\n\t\t`bvh degradation: ${ ( 100 * degradation ).toFixed( 2 ) }%`;\n\n}\n\nfunction calculateScore( bvhs ) {\n\n\tlet score = 0;\n\tbvhs.forEach( bvh => {\n\n\t\tconst extremes = getBVHExtremes( bvh );\n\t\tfor ( const i in extremes ) {\n\n\t\t\tscore += extremes[ i ].surfaceAreaScore;\n\n\t\t}\n\n\t} );\n\n\treturn score;\n\n}\n\nfunction updateRaycast() {\n\n\tif ( ! model ) {\n\n\t\treturn;\n\n\t}\n\n\traycaster.setFromCamera( mouse, camera );\n\n\t// override SkinnedMesh.prototype.raycast to use BVH if available based on the settings\n\tconst raycastFunc = params.bvhRaycast ?\n\t\tskinnedMeshAcceleratedRaycast :\n\t\tTHREE.SkinnedMesh.prototype.raycast;\n\n\tmodel.traverse( c => {\n\n\t\tif ( c.isSkinnedMesh ) {\n\n\t\t\tc.raycast = raycastFunc;\n\n\t\t}\n\n\t} );\n\n\t// run the raycasting\n\tconst startTime = window.performance.now();\n\tconst intersects = raycaster.intersectObject( model, true );\n\tconst hit = intersects[ 0 ];\n\n\tif ( hit ) {\n\n\t\tsphereCollision.position.copy( hit.point );\n\t\tsphereCollision.visible = true;\n\n\t} else {\n\n\t\tsphereCollision.visible = false;\n\n\t}\n\n\tconst delta = window.performance.now() - startTime;\n\tconst refitInfo = outputContainer.innerHTML;\n\tconst lines = refitInfo.split( '\\n' );\n\tif ( lines.length > 1 ) {\n\n\t\toutputContainer.innerHTML =\n\t\t\tlines[ 0 ] + '\\n' +\n\t\t\tlines[ 1 ] + '\\n' +\n\t\t\t`raycast time: ${ delta.toFixed( 2 ) } ms`;\n\n\t} else {\n\n\t\toutputContainer.innerHTML = `raycast time: ${ delta.toFixed( 2 ) } ms`;\n\n\t}\n\n}\n\nfunction render() {\n\n\tstats.update();\n\n\tconst delta = Math.min( clock.getDelta(), 30 * 0.001 );\n\n\t// update animation and helpers\n\tif ( mixer ) {\n\n\t\tmixer.update( delta );\n\t\tskeletonHelper.visible = params.skeletonHelper;\n\t\thelpers.forEach( helper => {\n\n\t\t\thelper.visible = params.bvhHelper;\n\n\t\t} );\n\n\t}\n\n\tscene.updateMatrixWorld( true );\n\n\t// refit on a cycle\n\tif ( params.autoUpdate && ! params.pause ) {\n\n\t\trefitBVH();\n\n\t}\n\n\t// update raycast\n\tupdateRaycast();\n\n\trenderer.render( scene, camera );\n\n}\n"],"names":["_v0","Vector3","_v1","_v2","_ray","Ray","_inverseMatrix","Matrix4","_localPoint","_axes","_raycast","SkinnedMesh","skinnedMeshAcceleratedRaycast","raycaster","intersects","SkinnedMeshBVH","GeometryBVH","mesh","options","SKIP_GENERATION","i","targetBuffer","baseIndex","geometry","indirectBuffer","index","tri3","ai","bi","ci","el","axis","a","b","c","min","max","callbacks","triangle","ExtendedTriangle","iterateOverTriangles","object","material","matrixWorld","firstHitOnly","closestHit","closestDistance","box","INTERSECTED","NOT_INTERSECTED","tri","triIndex","point","FrontSide","BackSide","dist","triOffset","barycoord","Triangle","hit","uv","uv1","normal","Vector2","offset","count","bvh","intersectsTriangleFunc","contained","depth","l","i0","i1","i2","params","refitBVH","renderer","camera","scene","clock","gui","stats","outputContainer","controls","mixer","animationAction","model","skeletonHelper","initialScore","bvhs","helpers","mouse","sphereCollision","init","THREE.WebGLRenderer","render","THREE.PCFShadowMap","THREE.Scene","light","THREE.DirectionalLight","shadowCam","THREE.AmbientLight","THREE.PerspectiveCamera","OrbitControls","THREE.Clock","Stats","THREE.Raycaster","THREE.Vector2","sphereGeometry","THREE.SphereGeometry","sphereMaterial","THREE.MeshBasicMaterial","THREE.Mesh","GLTFLoader","gltf","helper","BVHHelper","THREE.SkeletonHelper","animations","THREE.AnimationMixer","THREE.Box3","calculateScore","plane","THREE.PlaneGeometry","THREE.ShadowMaterial","GUI","v","helperFolder","bvhFolder","e","refitTime","start","degradation","score","extremes","getBVHExtremes","updateRaycast","raycastFunc","THREE.SkinnedMesh","startTime","delta","lines"],"mappings":"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"}