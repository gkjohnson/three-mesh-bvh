{"version":3,"file":"GenerateMeshBVHWorker-vOgOjCfJ.js","sources":["../../../src/workers/utils/WorkerBase.js","../../../src/workers/GenerateMeshBVHWorker.js"],"sourcesContent":["export class WorkerBase {\n\n\tconstructor( worker ) {\n\n\t\tthis.name = 'WorkerBase';\n\t\tthis.running = false;\n\t\tthis.worker = worker;\n\t\tthis.worker.onerror = e => {\n\n\t\t\tif ( e.message ) {\n\n\t\t\t\tthrow new Error( `${ this.name }: Could not create Web Worker with error \"${ e.message }\"` );\n\n\t\t\t} else {\n\n\t\t\t\tthrow new Error( `${ this.name }: Could not create Web Worker.` );\n\n\t\t\t}\n\n\t\t};\n\n\t}\n\n\trunTask() {}\n\n\tgenerate( ...args ) {\n\n\t\tif ( this.running ) {\n\n\t\t\tthrow new Error( 'GenerateMeshBVHWorker: Already running job.' );\n\n\t\t}\n\n\t\tif ( this.worker === null ) {\n\n\t\t\tthrow new Error( 'GenerateMeshBVHWorker: Worker has been disposed.' );\n\n\t\t}\n\n\t\tthis.running = true;\n\n\t\tconst promise = this.runTask( this.worker, ...args );\n\t\tpromise.finally( () => {\n\n\t\t\tthis.running = false;\n\n\t\t} );\n\n\t\treturn promise;\n\n\t}\n\n\tdispose() {\n\n\t\tthis.worker.terminate();\n\t\tthis.worker = null;\n\n\t}\n\n}\n","import { Box3, BufferAttribute } from 'three';\nimport { MeshBVH } from '../core/MeshBVH.js';\nimport { WorkerBase } from './utils/WorkerBase.js';\n\nexport class GenerateMeshBVHWorker extends WorkerBase {\n\n\tconstructor() {\n\n\t\tconst worker = new Worker( new URL( './generateMeshBVH.worker.js', import.meta.url ), { type: 'module' } );\n\t\tsuper( worker );\n\t\tthis.name = 'GenerateMeshBVHWorker';\n\n\t}\n\n\trunTask( worker, geometry, options = {} ) {\n\n\t\treturn new Promise( ( resolve, reject ) => {\n\n\t\t\tif (\n\t\t\t\tgeometry.getAttribute( 'position' ).isInterleavedBufferAttribute ||\n\t\t\t\tgeometry.index && geometry.index.isInterleavedBufferAttribute\n\t\t\t) {\n\n\t\t\t\tthrow new Error( 'GenerateMeshBVHWorker: InterleavedBufferAttribute are not supported for the geometry attributes.' );\n\n\t\t\t}\n\n\t\t\tworker.onerror = e => {\n\n\t\t\t\treject( new Error( `GenerateMeshBVHWorker: ${ e.message }` ) );\n\n\t\t\t};\n\n\t\t\tworker.onmessage = e => {\n\n\t\t\t\tconst { data } = e;\n\n\t\t\t\tif ( data.error ) {\n\n\t\t\t\t\treject( new Error( data.error ) );\n\t\t\t\t\tworker.onmessage = null;\n\n\t\t\t\t} else if ( data.serialized ) {\n\n\t\t\t\t\tconst { serialized, position } = data;\n\t\t\t\t\tconst bvh = MeshBVH.deserialize( serialized, geometry, { setIndex: false } );\n\t\t\t\t\tconst boundsOptions = Object.assign( {\n\n\t\t\t\t\t\tsetBoundingBox: true,\n\n\t\t\t\t\t}, options );\n\n\t\t\t\t\t// we need to replace the arrays because they're neutered entirely by the\n\t\t\t\t\t// webworker transfer.\n\t\t\t\t\tgeometry.attributes.position.array = position;\n\t\t\t\t\tif ( serialized.index ) {\n\n\t\t\t\t\t\tif ( geometry.index ) {\n\n\t\t\t\t\t\t\tgeometry.index.array = serialized.index;\n\n\t\t\t\t\t\t} else {\n\n\t\t\t\t\t\t\tconst newIndex = new BufferAttribute( serialized.index, 1, false );\n\t\t\t\t\t\t\tgeometry.setIndex( newIndex );\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t}\n\n\t\t\t\t\tif ( boundsOptions.setBoundingBox ) {\n\n\t\t\t\t\t\tgeometry.boundingBox = bvh.getBoundingBox( new Box3() );\n\n\t\t\t\t\t}\n\n\t\t\t\t\tif ( options.onProgress ) {\n\n\t\t\t\t\t\toptions.onProgress( data.progress );\n\n\t\t\t\t\t}\n\n\t\t\t\t\tresolve( bvh );\n\t\t\t\t\tworker.onmessage = null;\n\n\t\t\t\t} else if ( options.onProgress ) {\n\n\t\t\t\t\toptions.onProgress( data.progress );\n\n\t\t\t\t}\n\n\t\t\t};\n\n\t\t\tconst index = geometry.index ? geometry.index.array : null;\n\t\t\tconst position = geometry.attributes.position.array;\n\t\t\tconst transferable = [ position ];\n\t\t\tif ( index ) {\n\n\t\t\t\ttransferable.push( index );\n\n\t\t\t}\n\n\t\t\tworker.postMessage( {\n\n\t\t\t\tindex,\n\t\t\t\tposition,\n\t\t\t\toptions: {\n\t\t\t\t\t...options,\n\t\t\t\t\tonProgress: null,\n\t\t\t\t\tincludedProgressCallback: Boolean( options.onProgress ),\n\t\t\t\t\tgroups: [ ... geometry.groups ],\n\t\t\t\t},\n\n\t\t\t}, transferable.map( arr => arr.buffer ).filter( v => ( typeof SharedArrayBuffer === 'undefined' ) || ! ( v instanceof SharedArrayBuffer ) ) );\n\n\t\t} );\n\n\t}\n\n}\n"],"names":["WorkerBase","worker","args","promise","GenerateMeshBVHWorker","geometry","options","resolve","reject","e","data","serialized","position","bvh","MeshBVH","boundsOptions","newIndex","BufferAttribute","Box3","index","transferable","arr","v"],"mappings":"oGAAO,MAAMA,CAAW,CAEvB,YAAaC,EAAS,CAErB,KAAK,KAAO,aACZ,KAAK,QAAU,GACf,KAAK,OAASA,EACd,KAAK,OAAO,QAAU,GAAK,CAE1B,MAAK,EAAE,QAEA,IAAI,MAAO,GAAI,KAAK,IAAI,6CAA+C,EAAE,OAAO,GAAI,EAIpF,IAAI,MAAO,GAAI,KAAK,IAAI,gCAAiC,CAIjE,CAED,CAEA,SAAU,CAAC,CAEX,YAAaC,EAAO,CAEnB,GAAK,KAAK,QAET,MAAM,IAAI,MAAO,6CAA6C,EAI/D,GAAK,KAAK,SAAW,KAEpB,MAAM,IAAI,MAAO,kDAAkD,EAIpE,KAAK,QAAU,GAEf,MAAMC,EAAU,KAAK,QAAS,KAAK,OAAQ,GAAGD,CAAI,EAClD,OAAAC,EAAQ,QAAS,IAAM,CAEtB,KAAK,QAAU,EAEhB,CAAC,EAEMA,CAER,CAEA,SAAU,CAET,KAAK,OAAO,UAAS,EACrB,KAAK,OAAS,IAEf,CAED,CCvDO,MAAMC,UAA8BJ,CAAW,CAErD,aAAc,CAEb,MAAMC,EAAS,IAAI,OAAQ,IAAA,IAAA,GAAA,IAAA,IAAA,qCAAA,YAAA,GAAA,EAAA,KAAA,YAAA,GAAA,EAA2D,CAAE,KAAM,QAAQ,CAAE,EACxG,MAAOA,CAAM,EACb,KAAK,KAAO,uBAEb,CAEA,QAASA,EAAQI,EAAUC,EAAU,CAAA,EAAK,CAEzC,OAAO,IAAI,QAAS,CAAEC,EAASC,IAAY,CAE1C,GACCH,EAAS,aAAc,UAAU,EAAG,8BACpCA,EAAS,OAASA,EAAS,MAAM,6BAGjC,MAAM,IAAI,MAAO,kGAAkG,EAIpHJ,EAAO,QAAUQ,GAAK,CAErBD,EAAQ,IAAI,MAAO,0BAA2BC,EAAE,OAAO,GAAK,CAE7D,EAEAR,EAAO,UAAYQ,GAAK,CAEvB,KAAM,CAAE,KAAAC,CAAI,EAAKD,EAEjB,GAAKC,EAAK,MAETF,EAAQ,IAAI,MAAOE,EAAK,KAAK,CAAE,EAC/BT,EAAO,UAAY,aAERS,EAAK,WAAa,CAE7B,KAAM,CAAE,WAAAC,EAAY,SAAAC,CAAQ,EAAKF,EAC3BG,EAAMC,EAAQ,YAAaH,EAAYN,EAAU,CAAE,SAAU,GAAO,EACpEU,EAAgB,OAAO,OAAQ,CAEpC,eAAgB,EAEtB,EAAQT,CAAO,EAKV,GADAD,EAAS,WAAW,SAAS,MAAQO,EAChCD,EAAW,MAEf,GAAKN,EAAS,MAEbA,EAAS,MAAM,MAAQM,EAAW,UAE5B,CAEN,MAAMK,EAAW,IAAIC,EAAiBN,EAAW,MAAO,EAAG,EAAK,EAChEN,EAAS,SAAUW,CAAQ,CAE5B,CAIID,EAAc,iBAElBV,EAAS,YAAcQ,EAAI,eAAgB,IAAIK,CAAM,GAIjDZ,EAAQ,YAEZA,EAAQ,WAAYI,EAAK,QAAQ,EAIlCH,EAASM,CAAG,EACZZ,EAAO,UAAY,IAEpB,MAAYK,EAAQ,YAEnBA,EAAQ,WAAYI,EAAK,QAAQ,CAInC,EAEA,MAAMS,EAAQd,EAAS,MAAQA,EAAS,MAAM,MAAQ,KAChDO,EAAWP,EAAS,WAAW,SAAS,MACxCe,EAAe,CAAER,CAAQ,EAC1BO,GAEJC,EAAa,KAAMD,CAAK,EAIzBlB,EAAO,YAAa,CAEnB,MAAAkB,EACA,SAAAP,EACA,QAAS,CACR,GAAGN,EACH,WAAY,KACZ,yBAA0B,EAASA,EAAQ,WAC3C,OAAQ,CAAE,GAAID,EAAS,MAAM,CAClC,CAEA,EAAMe,EAAa,IAAKC,GAAOA,EAAI,MAAM,EAAG,OAAQC,GAAO,OAAO,kBAAsB,KAAiB,EAAIA,aAAa,kBAAmB,CAAE,CAE7I,CAAC,CAEF,CAED"}