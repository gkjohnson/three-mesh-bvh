{"version":3,"file":"ExtensionUtilities-BlnM4xb7.js","sources":["../../../src/utils/ExtensionUtilities.js"],"sourcesContent":["import { Mesh, Points, Line, LineLoop, LineSegments, Sphere, BatchedMesh, REVISION } from 'three';\nimport { MeshBVH } from '../core/MeshBVH.js';\n\nconst IS_REVISION_166 = parseInt( REVISION ) >= 166;\n\n// TODO: how can we expand these raycast functions?\nconst _raycastFunctions = {\n\t'Mesh': Mesh.prototype.raycast,\n\t'Line': Line.prototype.raycast,\n\t'LineSegments': LineSegments.prototype.raycast,\n\t'LineLoop': LineLoop.prototype.raycast,\n\t'Points': Points.prototype.raycast,\n\t'BatchedMesh': BatchedMesh.prototype.raycast,\n};\n\nconst _mesh = /* @__PURE__ */ new Mesh();\nconst _batchIntersects = [];\n\nexport function acceleratedRaycast( raycaster, intersects ) {\n\n\tif ( this.isBatchedMesh ) {\n\n\t\tacceleratedBatchedMeshRaycast.call( this, raycaster, intersects );\n\n\t} else {\n\n\t\tconst { geometry } = this;\n\t\tif ( geometry.boundsTree ) {\n\n\t\t\tgeometry.boundsTree.raycastObject3D( this, raycaster, intersects );\n\n\t\t} else {\n\n\t\t\tlet raycastFunction;\n\t\t\tif ( this instanceof Mesh ) {\n\n\t\t\t\traycastFunction = _raycastFunctions.Mesh;\n\n\t\t\t} else if ( this instanceof LineSegments ) {\n\n\t\t\t\traycastFunction = _raycastFunctions.LineSegments;\n\n\t\t\t} else if ( this instanceof LineLoop ) {\n\n\t\t\t\traycastFunction = _raycastFunctions.LineLoop;\n\n\t\t\t} else if ( this instanceof Line ) {\n\n\t\t\t\traycastFunction = _raycastFunctions.Line;\n\n\t\t\t} else if ( this instanceof Points ) {\n\n\t\t\t\traycastFunction = _raycastFunctions.Points;\n\n\t\t\t} else {\n\n\t\t\t\tthrow new Error( 'BVH: Fallback raycast function not found.' );\n\n\t\t\t}\n\n\t\t\traycastFunction.call( this, raycaster, intersects );\n\n\t\t}\n\n\t}\n\n}\n\nfunction acceleratedBatchedMeshRaycast( raycaster, intersects ) {\n\n\tif ( this.boundsTrees ) {\n\n\t\t// TODO: remove use of geometry info, instance info when r170 is minimum version\n\t\tconst boundsTrees = this.boundsTrees;\n\t\tconst drawInfo = this._drawInfo || this._instanceInfo;\n\t\tconst drawRanges = this._drawRanges || this._geometryInfo;\n\t\tconst matrixWorld = this.matrixWorld;\n\n\t\t_mesh.material = this.material;\n\t\t_mesh.geometry = this.geometry;\n\n\t\tconst oldBoundsTree = _mesh.geometry.boundsTree;\n\t\tconst oldDrawRange = _mesh.geometry.drawRange;\n\n\t\tif ( _mesh.geometry.boundingSphere === null ) {\n\n\t\t\t_mesh.geometry.boundingSphere = new Sphere();\n\n\t\t}\n\n\t\t// TODO: provide new method to get instances count instead of 'drawInfo.length'\n\t\tfor ( let i = 0, l = drawInfo.length; i < l; i ++ ) {\n\n\t\t\tif ( ! this.getVisibleAt( i ) ) {\n\n\t\t\t\tcontinue;\n\n\t\t\t}\n\n\t\t\t// TODO: use getGeometryIndex\n\t\t\tconst geometryId = drawInfo[ i ].geometryIndex;\n\n\t\t\t_mesh.geometry.boundsTree = boundsTrees[ geometryId ];\n\n\t\t\tthis.getMatrixAt( i, _mesh.matrixWorld ).premultiply( matrixWorld );\n\n\t\t\tif ( ! _mesh.geometry.boundsTree ) {\n\n\t\t\t\tthis.getBoundingBoxAt( geometryId, _mesh.geometry.boundingBox );\n\t\t\t\tthis.getBoundingSphereAt( geometryId, _mesh.geometry.boundingSphere );\n\n\t\t\t\tconst drawRange = drawRanges[ geometryId ];\n\t\t\t\t_mesh.geometry.setDrawRange( drawRange.start, drawRange.count );\n\n\t\t\t}\n\n\t\t\t_mesh.raycast( raycaster, _batchIntersects );\n\n\t\t\tfor ( let j = 0, l = _batchIntersects.length; j < l; j ++ ) {\n\n\t\t\t\tconst intersect = _batchIntersects[ j ];\n\t\t\t\tintersect.object = this;\n\t\t\t\tintersect.batchId = i;\n\t\t\t\tintersects.push( intersect );\n\n\t\t\t}\n\n\t\t\t_batchIntersects.length = 0;\n\n\t\t}\n\n\t\t_mesh.geometry.boundsTree = oldBoundsTree;\n\t\t_mesh.geometry.drawRange = oldDrawRange;\n\t\t_mesh.material = null;\n\t\t_mesh.geometry = null;\n\n\t} else {\n\n\t\t_raycastFunctions.BatchedMesh.call( this, raycaster, intersects );\n\n\t}\n\n}\n\nexport function computeBoundsTree( options = {} ) {\n\n\tconst { type = MeshBVH } = options;\n\tthis.boundsTree = new type( this, options );\n\treturn this.boundsTree;\n\n}\n\nexport function disposeBoundsTree() {\n\n\tthis.boundsTree = null;\n\n}\n\nexport function computeBatchedBoundsTree( index = - 1, options = {} ) {\n\n\tif ( ! IS_REVISION_166 ) {\n\n\t\tthrow new Error( 'BatchedMesh: Three r166+ is required to compute bounds trees.' );\n\n\t}\n\n\toptions = {\n\t\t...options,\n\t\trange: null\n\t};\n\n\tconst drawRanges = this._drawRanges || this._geometryInfo;\n\tconst geometryCount = this._geometryCount;\n\tif ( ! this.boundsTrees ) {\n\n\t\tthis.boundsTrees = new Array( geometryCount ).fill( null );\n\n\t}\n\n\tconst boundsTrees = this.boundsTrees;\n\twhile ( boundsTrees.length < geometryCount ) {\n\n\t\tboundsTrees.push( null );\n\n\t}\n\n\tif ( index < 0 ) {\n\n\t\tfor ( let i = 0; i < geometryCount; i ++ ) {\n\n\t\t\toptions.range = drawRanges[ i ];\n\t\t\tboundsTrees[ i ] = new MeshBVH( this.geometry, options );\n\n\t\t}\n\n\t\treturn boundsTrees;\n\n\t} else {\n\n\t\tif ( index < drawRanges.length ) {\n\n\t\t\toptions.range = drawRanges[ index ];\n\t\t\tboundsTrees[ index ] = new MeshBVH( this.geometry, options );\n\n\t\t}\n\n\t\treturn boundsTrees[ index ] || null;\n\n\t}\n\n}\n\nexport function disposeBatchedBoundsTree( index = - 1 ) {\n\n\tif ( index < 0 ) {\n\n\t\tthis.boundsTrees.fill( null );\n\n\t} else {\n\n\t\tif ( index < this.boundsTrees.length ) {\n\n\t\t\tthis.boundsTrees[ index ] = null;\n\n\t\t}\n\n\t}\n\n}\n"],"names":["IS_REVISION_166","REVISION","_raycastFunctions","Mesh","Line","LineSegments","LineLoop","Points","BatchedMesh","_mesh","_batchIntersects","acceleratedRaycast","raycaster","intersects","acceleratedBatchedMeshRaycast","geometry","raycastFunction","boundsTrees","drawInfo","drawRanges","matrixWorld","oldBoundsTree","oldDrawRange","Sphere","i","l","geometryId","drawRange","j","intersect","computeBoundsTree","options","type","MeshBVH","disposeBoundsTree","computeBatchedBoundsTree","index","geometryCount","disposeBatchedBoundsTree"],"mappings":"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"}