import{G as A,w as P,f as _,n as E,O as v,M as W,i as x,B as M,b as j,V as F}from"./ExtendedTriangle-hsPasuNU.js";import{M as G,n as z}from"./MeshBVH-DQV6PBDm.js";const B=new j,w=new E,m=new F;class L extends v{get isMesh(){return!this.displayEdges}get isLineSegments(){return this.displayEdges}get isLine(){return this.displayEdges}getVertexPosition(...t){return W.prototype.getVertexPosition.call(this,...t)}constructor(t,e,s=10,o=0){super(),this.material=e,this.geometry=new x,this.name="BVHRootHelper",this.depth=s,this.displayParents=!1,this.bvh=t,this.displayEdges=!0,this._group=o}raycast(){}update(){const t=this.bvh;this.geometry.dispose(),this.visible=!1,t&&(this.geometry=this.getGeometry(t),this.visible=!0)}getGeometry(t){const e=this._group;let s=null;if(e!==-1)s=this.getBVHBoundPositions(t,e);else{const r=t._roots.map((n,a)=>this.getBVHBoundPositions(t,a)),l=r.reduce((n,a)=>n+a.length,0);s=new Float32Array(l);let h=0;r.forEach(n=>{s.set(n,h),h+=n.length})}const o=this.getBVHBoundIndices(s),i=new x;return i.setIndex(new M(o,1,!1)),i.setAttribute("position",new M(s,3,!1)),i}getBVHBoundIndices(t){const e=t.length/24;let s,o;this.displayEdges?o=new Uint8Array([0,4,1,5,2,6,3,7,0,2,1,3,4,6,5,7,0,1,2,3,4,5,6,7]):o=new Uint8Array([0,1,2,2,1,3,4,6,5,6,7,5,1,4,5,0,4,1,2,3,6,3,7,6,0,2,4,2,6,4,1,5,3,3,5,7]),t.length>65535?s=new Uint32Array(o.length*e):s=new Uint16Array(o.length*e);const i=o.length;for(let r=0;r<e;r++){const l=r*8,h=r*i;for(let n=0;n<i;n++)s[h+n]=l+o[n]}return s}getBVHBoundPositions(t,e=0,s=null){const o=this.depth-1,i=this.displayParents;let r=0;t.traverse((n,a)=>{if(n>=o||a)return r++,!0;i&&r++},e);let l=0;const h=new Float32Array(24*r);return t.traverse((n,a,d)=>{const c=n>=o||a;if(c||i){z(0,d,B);const{min:p,max:u}=B;for(let y=-1;y<=1;y+=2){const I=y<0?p.x:u.x;for(let g=-1;g<=1;g+=2){const V=g<0?p.y:u.y;for(let f=-1;f<=1;f+=2){const H=f<0?p.z:u.z;m.set(I,V,H),s&&m.applyMatrix4(s),m.toArray(h,l),l+=3}}}return c}},e),h}}class b extends A{get color(){return this.edgeMaterial.color}get opacity(){return this.edgeMaterial.opacity}set opacity(t){this.edgeMaterial.opacity=t,this.meshMaterial.opacity=t}get objectIndex(){return console.warn('BVHHelper: "objectIndex" has been renamed "instanceId".'),this.instanceId}set objectIndex(t){console.warn('BVHHelper: "objectIndex" has been renamed "instanceId".'),this.instanceId=t}constructor(t=null,e=null,s=10){t instanceof G&&(s=e||10,e=t,t=null),typeof e=="number"&&(s=e,e=null),super(),this.name="BVHHelper",this.depth=s,this.mesh=t,this.bvh=e,this.displayParents=!1,this.displayEdges=!0,this.instanceId=0,this._roots=[];const o=new P({color:65416,transparent:!0,opacity:.3,depthWrite:!1}),i=new _({color:65416,transparent:!0,opacity:.3,depthWrite:!1});i.color=o.color,this.edgeMaterial=o,this.meshMaterial=i,this.update()}update(){const t=this.mesh,e=this.instanceId;let s=this.bvh||t.boundsTree||t.geometry&&t.geometry.boundsTree||null;if(t&&t.isBatchedMesh&&t.boundsTrees&&!s&&e>=0){const i=t._drawInfo[e];i&&(s=t.boundsTrees[i.geometryIndex]||s)}const o=s?s._roots.length:0;for(;this._roots.length>o;){const i=this._roots.pop();i.geometry.dispose(),this.remove(i)}for(let i=0;i<o;i++){const{depth:r,edgeMaterial:l,meshMaterial:h,displayParents:n,displayEdges:a}=this;if(i>=this._roots.length){const c=new L(s,l,r,i);this.add(c),this._roots.push(c)}const d=this._roots[i];d.bvh=s,d.depth=r,d.displayParents=n,d.displayEdges=a,d.material=a?l:h,d.update()}}updateMatrixWorld(...t){const e=this.mesh,s=this.parent,o=this.instanceId;e!==null&&(e.updateWorldMatrix(!0,!1),s?this.matrix.copy(s.matrixWorld).invert().multiply(e.matrixWorld):this.matrix.copy(e.matrixWorld),(e.isInstancedMesh||e.isBatchedMesh)&&o>=0&&(e.getMatrixAt(o,w),this.matrix.multiply(w)),this.matrix.decompose(this.position,this.quaternion,this.scale)),super.updateMatrixWorld(...t)}copy(t){this.depth=t.depth,this.mesh=t.mesh,this.bvh=t.bvh,this.opacity=t.opacity,this.color.copy(t.color)}clone(){return new b().copy(this)}dispose(){this.edgeMaterial.dispose(),this.meshMaterial.dispose();const t=this.children;for(let e=0,s=t.length;e<s;e++)t[e].geometry.dispose()}}export{b as B};
//# sourceMappingURL=BVHHelper-DA_xcAFF.js.map
